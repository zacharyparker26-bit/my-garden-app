<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Balcony Garden Manager</title>
    
    <!-- MOBILE APP CONFIGURATION -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/628/628283.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        :root {
            --bg-color: #1e293b;
            --card-bg: #fdfbf7; 
            --accent-wood: #78350f;
        }
        body {
            background-color: var(--bg-color);
            font-family: 'Nunito', sans-serif;
            color: #e2e8f0;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, h3, .pixel-font { font-family: 'VT323', monospace; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-shadow { box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.3); border-bottom: 3px solid #0f172a; border-right: 3px solid #0f172a; }
        .wood-btn { background-color: #92400e; border: 2px solid #451a03; border-bottom-width: 4px; color: #fef3c7; text-shadow: 1px 1px 0 #451a03; }
        .wood-btn:hover { background-color: #b45309; }
        .wood-btn:active { transform: translateY(2px); border-bottom-width: 2px; }
        .library-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .library-scroll::-webkit-scrollbar-track { background: #334155; }
        .library-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        
        /* MOVEMENT ACROSS SCREEN (X-Axis) */
        @keyframes drift { from { transform: translateX(-20vw); } to { transform: translateX(120vw); } }
        @keyframes drift-reverse { from { transform: translateX(120vw); } to { transform: translateX(-20vw); } }
        
        /* BUG PAUSE ANIMATIONS (Move, Stop, Move) */
        @keyframes drift-pause-early { 
            0% { transform: translateX(-10vw); } 
            30% { transform: translateX(25vw); } 
            45% { transform: translateX(25vw); } /* Pause to check plants */
            100% { transform: translateX(120vw); } 
        }
        @keyframes drift-pause-late { 
            0% { transform: translateX(-10vw); } 
            60% { transform: translateX(70vw); } 
            75% { transform: translateX(70vw); } /* Pause to check plants */
            100% { transform: translateX(120vw); } 
        }

        /* LOCAL CREATURE MOVEMENT (Y-Axis / Rotation / Scale) */
        @keyframes fly { 
            0% { transform: translateY(0) rotate(0deg); } 
            25% { transform: translateY(-5px) rotate(5deg); } 
            50% { transform: translateY(0) rotate(0deg); } 
            75% { transform: translateY(5px) rotate(-5deg); } 
            100% { transform: translateY(0) rotate(0deg); } 
        }
        @keyframes flutter {
            0%, 100% { transform: translateY(0) scaleX(1); }
            50% { transform: translateY(-15px) scaleX(0.7); }
        }
        @keyframes buzz {
            0% { transform: translate(0, 0); }
            25% { transform: translate(2px, -2px); }
            50% { transform: translate(0, -4px); }
            75% { transform: translate(-2px, -2px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes flap {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }
        
        @keyframes growUp { 0% { transform: scaleY(0); opacity: 0; } 100% { transform: scaleY(1); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Sway only the plant parts, anchored at bottom */
        @keyframes sway { 
            0%, 100% { transform: rotate(-3deg); } 
            50% { transform: rotate(3deg); } 
        }
        .animate-sway { 
            transform-origin: center bottom; 
            animation: sway 4s ease-in-out infinite; 
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-twinkle { animation: twinkle 3s ease-in-out infinite; }
        
        /* CLOUD SPEEDS */
        .animate-drift { animation: drift 100s linear infinite; }
        .animate-drift-fast { animation: drift 60s linear infinite; }
        .animate-drift-slow { animation: drift 150s linear infinite; }
        .animate-drift-slower { animation: drift 200s linear infinite; }
        
        /* ANIMAL SPEEDS (Crossing Screen) */
        .crossing-fast { animation: drift 15s linear infinite; }
        .crossing-med { animation: drift 25s linear infinite; }
        .crossing-slow { animation: drift 35s linear infinite; }
        
        .crossing-reverse-fast { animation: drift-reverse 15s linear infinite; }
        .crossing-reverse-med { animation: drift-reverse 25s linear infinite; }
        .crossing-reverse-slow { animation: drift-reverse 35s linear infinite; }
        
        /* BUG VISITING SPEEDS */
        .visiting-early { animation: drift-pause-early 45s linear infinite; }
        .visiting-late { animation: drift-pause-late 60s linear infinite; }

        /* LOCAL ANIMATIONS (Applied to inner element) */
        .local-fly { animation: fly 2s ease-in-out infinite; }
        .local-fly-slow { animation: fly 3s ease-in-out infinite; }
        .local-flutter { animation: flutter 0.2s ease-in-out infinite; }
        .local-buzz { animation: buzz 0.1s linear infinite; }
        .wing-flap { transform-origin: center 5px; animation: flap 0.2s infinite; }
        
        .animate-grow { transform-origin: bottom center; animation: growUp 0.8s ease-out forwards; }
        .animate-pop { animation: popIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .pixel-art { image-rendering: pixelated; shape-rendering: crispEdges; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- POT MODIFIERS ---
        const CONTAINER_MATERIALS = [
            { label: "Plastic", waterMod: 1.2, fertMod: 1.0 }, 
            { label: "Terra Cotta (Clay)", waterMod: 0.7, fertMod: 0.9 }, 
            { label: "Fabric / Grow Bag", waterMod: 0.8, fertMod: 0.85 }, 
            { label: "Ceramic (Glazed)", waterMod: 1.3, fertMod: 1.0 }, 
            { label: "Self-Watering", waterMod: 2.0, fertMod: 1.1 }, 
            { label: "Wood Box", waterMod: 1.1, fertMod: 1.0 },
            { label: "Metal", waterMod: 0.9, fertMod: 1.0 } 
        ];

        const CONTAINER_SIZES = [
            { label: "Small (< 1 Gal)", waterMod: 0.7, fertMod: 0.8 }, 
            { label: "1 Gallon", waterMod: 0.8, fertMod: 0.9 },
            { label: "2 Gallon", waterMod: 0.9, fertMod: 0.95 },
            { label: "3 Gallon", waterMod: 1.0, fertMod: 1.0 }, 
            { label: "5 Gallon", waterMod: 1.3, fertMod: 1.0 },
            { label: "7 Gallon", waterMod: 1.5, fertMod: 1.1 },
            { label: "10 Gallon", waterMod: 1.8, fertMod: 1.1 },
            { label: "15+ Gallon", waterMod: 2.2, fertMod: 1.2 }
        ];

        // --- PLANT LIBRARY ---
        // Expanded with massive dataset of Peppers, Tomatoes, Veg, Fruit, Berries, Flowers
        const PLANT_LIBRARY = [
            // --- 1. PEPPERS (Capsicum) ---
            // Sweet
            { name: "Bell Pepper (California Wonder)", type: "pepper", waterFreq: 4, fertilizerFreq: 14, notes: "Blocky, thick walls.", tip: "Support heavy fruit." },
            { name: "Bell Pepper (Purple Beauty)", type: "pepper", waterFreq: 4, fertilizerFreq: 14, notes: "Turns deep purple.", tip: "Heat sensitive." },
            { name: "Sweet Pepper (Carmen)", type: "pepper", waterFreq: 4, fertilizerFreq: 14, notes: "Italian frying type.", tip: "Very productive." },
            { name: "Sweet Pepper (Banana)", type: "pepper", waterFreq: 3, fertilizerFreq: 14, notes: "Long yellow wax.", tip: "Pick early for mild." },
            { name: "Shishito Pepper", type: "pepper", waterFreq: 4, fertilizerFreq: 14, notes: "Japanese wrinkly.", tip: "1 in 10 are hot!" },
            // Mild/Medium
            { name: "Poblano (Ancho)", type: "pepper", waterFreq: 5, fertilizerFreq: 14, notes: "Heart shaped, dark.", tip: "Great for stuffing." },
            { name: "Jalapeno (Early)", type: "pepper", waterFreq: 5, fertilizerFreq: 14, notes: "Classic heat.", tip: "Corking lines = ripe." },
            { name: "Serrano", type: "pepper", waterFreq: 5, fertilizerFreq: 14, notes: "Hotter than Jalapeno.", tip: "Eat green or red." },
            { name: "Cayenne (Long Slim)", type: "pepper", waterFreq: 6, fertilizerFreq: 14, notes: "Dries easily.", tip: "Very spicy." },
            // Super Hot
            { name: "Habanero (Orange)", type: "pepper", waterFreq: 6, fertilizerFreq: 14, notes: "Fruity heat.", tip: "Slow to germinate." },
            { name: "Ghost Pepper (Bhut Jolokia)", type: "pepper", waterFreq: 6, fertilizerFreq: 14, notes: "Extreme heat.", tip: "Needs long season." },
            { name: "Carolina Reaper", type: "pepper", waterFreq: 6, fertilizerFreq: 14, notes: "Record holder heat.", tip: "Handle with gloves." },

            // --- 2. TOMATOES ---
            // Cherry/Grape
            { name: "Tomato (Sweet 100)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Clusters of small fruit.", tip: "Indeterminate (tall)." },
            { name: "Tomato (Sun Gold)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Orange, very sweet.", tip: "Cracks if overwatered." },
            { name: "Tomato (Yellow Pear)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Low acid, mild.", tip: "Vigorous vines." },
            { name: "Tomato (Black Cherry)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Complex, smoky flavor.", tip: "Heat tolerant." },
            // Paste
            { name: "Tomato (Roma VF)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: "Determinate (bushy).", tip: "Good for canning." },
            { name: "Tomato (San Marzano)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Classic sauce tomato.", tip: "Prone to blossom rot." },
            // Slicing/Beefsteak
            { name: "Tomato (Early Girl)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: "Reliable, fast.", tip: "Dry farming possible." },
            { name: "Tomato (Better Boy)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Hybrid, disease resistant.", tip: "Cage heavily." },
            { name: "Tomato (Cherokee Purple)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: "Heirloom, rich taste.", tip: "Thin skin." },
            { name: "Tomato (Brandywine)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: "Potato leaf, giant fruit.", tip: "Low yield but tasty." },
            { name: "Tomato (Green Zebra)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: "Tart and tangy.", tip: "Ripe when yellow-green." },
            { name: "Tomato (Burmese Sour)", type: "tomato", waterFreq: 3, fertilizerFreq: 14, notes: " distinct sour flavor.", tip: "Great for curries." },
            // Dwarf
            { name: "Tomato (Tiny Tim)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Micro dwarf.", tip: "Great for windowsills." },

            // --- 3. VEGETABLES ---
            // Cruciferous
            { name: "Broccoli (Calabrese)", type: "leafy", waterFreq: 3, fertilizerFreq: 21, notes: "Cool season.", tip: "Harvest main head first." },
            { name: "Cauliflower (Snowball)", type: "leafy", waterFreq: 3, fertilizerFreq: 21, notes: "Needs blanching.", tip: "Sensitive to heat." },
            { name: "Kale (Lacinato/Dino)", type: "leafy", waterFreq: 4, fertilizerFreq: 21, notes: "Dark blue-green.", tip: "Gets sweeter after frost." },
            { name: "Brussels Sprouts", type: "leafy", waterFreq: 4, fertilizerFreq: 21, notes: "Long season.", tip: "Remove lower leaves." },
            { name: "Bok Choy", type: "leafy", waterFreq: 2, fertilizerFreq: 14, notes: "Fast growing.", tip: "Bolts in heat." },
            // Roots
            { name: "Carrot (Danvers)", type: "root", waterFreq: 4, fertilizerFreq: 21, notes: "Standard orange.", tip: "Loose soil essential." },
            { name: "Carrot (Purple Haze)", type: "root", waterFreq: 4, fertilizerFreq: 21, notes: "Purple skin, orange core.", tip: "Antioxidant rich." },
            { name: "Radish (Cherry Belle)", type: "root", waterFreq: 2, fertilizerFreq: 0, notes: "Ready in 25 days.", tip: "Spicy in heat." },
            { name: "Beet (Detroit Dark Red)", type: "root", waterFreq: 3, fertilizerFreq: 21, notes: "Edible greens too.", tip: "Thin seedlings." },
            { name: "Onion (Sweet)", type: "root", waterFreq: 4, fertilizerFreq: 21, notes: "Short storage.", tip: "Nitrogen lover." },
            { name: "Garlic (Hardneck)", type: "root", waterFreq: 5, fertilizerFreq: 30, notes: "Plant in fall.", tip: "Harvest scapes." },
            { name: "Potato (Yukon Gold)", type: "root", waterFreq: 4, fertilizerFreq: 21, notes: "Buttery flesh.", tip: "Hilling required." },
            // Legumes
            { name: "Green Bean (Bush)", type: "bush", waterFreq: 3, fertilizerFreq: 30, notes: "No trellis needed.", tip: "Succession plant." },
            { name: "Peas (Sugar Snap)", type: "vine", waterFreq: 3, fertilizerFreq: 30, notes: "Edible pod.", tip: "Cool weather crop." },
            // Cucurbits
            { name: "Zucchini (Black Beauty)", type: "bush", waterFreq: 2, fertilizerFreq: 14, notes: "Very productive.", tip: "Check daily." },
            { name: "Cucumber (Marketmore)", type: "vine", waterFreq: 2, fertilizerFreq: 14, notes: "Slicing type.", tip: "Needs trellis." },
            { name: "Pumpkin (Sugar Pie)", type: "vine", waterFreq: 3, fertilizerFreq: 14, notes: "Baking pumpkin.", tip: "Needs heavy feeding." },
            // Leafy
            { name: "Lettuce (Romaine)", type: "leafy", waterFreq: 2, fertilizerFreq: 14, notes: "Upright head.", tip: "Heat tolerant." },
            { name: "Spinach (Bloomsdale)", type: "leafy", waterFreq: 3, fertilizerFreq: 14, notes: "Crinkled leaves.", tip: "Bolts quickly." },
            { name: "Swiss Chard (Rainbow)", type: "leafy", waterFreq: 4, fertilizerFreq: 21, notes: "Colorful stems.", tip: "Cut and come again." },

            // --- 4. FRUIT TREES (Container Friendly) ---
            { name: "Lemon (Meyer)", type: "tree", waterFreq: 5, fertilizerFreq: 30, notes: "Sweeter lemon.", tip: "Protect from frost." },
            { name: "Lime (Key)", type: "tree", waterFreq: 5, fertilizerFreq: 30, notes: "Small tart fruit.", tip: "Thorns present." },
            { name: "Orange (Moro Blood)", type: "tree", waterFreq: 5, fertilizerFreq: 30, notes: "Red flesh.", tip: "Raspberry notes." },
            { name: "Kumquat", type: "tree", waterFreq: 5, fertilizerFreq: 30, notes: "Eat whole.", tip: "Very ornamental." },
            { name: "Apple (Gala Dwarf)", type: "tree", waterFreq: 5, fertilizerFreq: 60, notes: "Crisp sweet.", tip: "Needs pollinator." },
            { name: "Fig (Brown Turkey)", type: "tree", waterFreq: 4, fertilizerFreq: 30, notes: "Reliable bearer.", tip: "Restrict roots." },
            { name: "Peach (Dwarf)", type: "tree", waterFreq: 4, fertilizerFreq: 30, notes: "Self-fertile.", tip: "Watch for leaf curl." },
            { name: "Cherry (Tart)", type: "tree", waterFreq: 5, fertilizerFreq: 60, notes: "Good for pies.", tip: "Bird netting needed." },

            // --- 5. BERRIES ---
            { name: "Strawberry (June)", type: "berry", waterFreq: 3, fertilizerFreq: 14, notes: "One big crop.", tip: "Mulch with straw." },
            { name: "Strawberry (Albion)", type: "berry", waterFreq: 3, fertilizerFreq: 14, notes: "Ever-bearing.", tip: "Consistent water." },
            { name: "Blueberry (Highbush)", type: "bush", waterFreq: 3, fertilizerFreq: 30, notes: "Needs acid soil.", tip: "Pine needle mulch." },
            { name: "Raspberry (Heritage)", type: "bush", waterFreq: 3, fertilizerFreq: 30, notes: "Fall bearing.", tip: "Prune canes." },
            { name: "Blackberry (Thornless)", type: "bush", waterFreq: 3, fertilizerFreq: 30, notes: "Vigorous grower.", tip: "Trellis needed." },
            { name: "Grapes (Table)", type: "vine", waterFreq: 7, fertilizerFreq: 60, notes: "Seedless.", tip: "Heavy pruning winter." },

            // --- 6. EXOTICS ---
            { name: "Dragon Fruit", type: "cactus", waterFreq: 10, fertilizerFreq: 30, notes: "Vining cactus.", tip: "Needs strong post." },
            { name: "Passion Fruit", type: "vine", waterFreq: 3, fertilizerFreq: 14, notes: "Beautiful flowers.", tip: "Heavy feeder." },
            { name: "Pineapple", type: "bromeliad", waterFreq: 7, fertilizerFreq: 30, notes: "Water the cup.", tip: "Takes 18m+." },
            { name: "Banana (Dwarf Cavendish)", type: "tree", waterFreq: 3, fertilizerFreq: 14, notes: "Heavy waterer.", tip: "Protect from wind." },
            { name: "Avocado (Dwarf)", type: "tree", waterFreq: 4, fertilizerFreq: 30, notes: "Sensitive roots.", tip: "Good drainage key." },
            { name: "Ginger", type: "root", waterFreq: 3, fertilizerFreq: 30, notes: "Shallow rhizomes.", tip: "Partial shade." },
            { name: "Turmeric", type: "root", waterFreq: 3, fertilizerFreq: 30, notes: "Harvest when leaves die.", tip: "Long warm season." },

            // --- 7. FLOWERS ---
            // Annuals
            { name: "Petunia (Wave)", type: "flower", waterFreq: 3, fertilizerFreq: 14, notes: "Spreading habit.", tip: "Deadhead for blooms." },
            { name: "Marigold (French)", type: "flower", waterFreq: 4, fertilizerFreq: 21, notes: "Companion plant.", tip: "Deters nematodes." },
            { name: "Sunflower (Mammoth)", type: "flower", waterFreq: 3, fertilizerFreq: 14, notes: "Giant height.", tip: "Follows the sun." },
            { name: "Zinnia", type: "flower", waterFreq: 4, fertilizerFreq: 21, notes: "Cut flower.", tip: "Resists drought." },
            { name: "Nasturtium", type: "flower", waterFreq: 5, fertilizerFreq: 0, notes: "Edible flowers.", tip: "Poor soil is fine." },
            { name: "Pansy", type: "flower", waterFreq: 3, fertilizerFreq: 14, notes: "Cold hardy.", tip: "Winter color." },
            // Perennials/Bulbs
            { name: "Rose (Knockout)", type: "flower", waterFreq: 4, fertilizerFreq: 30, notes: "Disease resistant.", tip: "Prune spring." },
            { name: "Lavender (English)", type: "flower", waterFreq: 7, fertilizerFreq: 60, notes: "Fragrant.", tip: "Likes lime/grit." },
            { name: "Tulip", type: "flower", waterFreq: 7, fertilizerFreq: 0, notes: "Spring bulb.", tip: "Chill bulbs before planting." },
            { name: "Orchid (Phalaenopsis)", type: "flower", waterFreq: 7, fertilizerFreq: 14, notes: "Epiphyte.", tip: "Do not use soil." },
            { name: "Bird of Paradise", type: "flower", waterFreq: 7, fertilizerFreq: 30, notes: "Tropical look.", tip: "Crowded roots bloom best." },
            { name: "Hibiscus (Tropical)", type: "flower", waterFreq: 2, fertilizerFreq: 14, notes: "Huge blooms.", tip: "Thirsty plant." }
        ];

        // --- NATURAL PALETTES ---
        const PALETTES = {
            healthy: { stem: '#5F6F52', leafLight: '#A9B388', leafDark: '#4F6F52', fruit: '#B91C1C', fruitAlt: '#EAB308', root: '#D97706' },
            dry: { stem: '#78716C', leafLight: '#D6D3D1', leafDark: '#A8A29E', fruit: '#7F1D1D', fruitAlt: '#92400E', root: '#92400E' },
            hungry: { stem: '#A3E635', leafLight: '#FEF08A', leafDark: '#D9F99D', fruit: '#FCA5A5', fruitAlt: '#FDE047', root: '#FDBA74' }
        };

        // --- PIXEL ART SPRITES ---
        const PixelPot = ({ color = "#8B4513" }) => (
            <g>
                <rect x="5" y="16" width="14" height="6" fill={color} />
                <rect x="4" y="14" width="16" height="2" fill="#5e2f0d" />
                <rect x="6" y="18" width="2" height="2" fill="rgba(0,0,0,0.2)" />
                <rect x="16" y="18" width="2" height="2" fill="rgba(0,0,0,0.2)" />
            </g>
        );

        const PixelTable = () => (
            <g>
                <rect x="0" y="20" width="24" height="2" fill="#5c401f" />
                <rect x="0" y="22" width="24" height="1" fill="#3f2e18" />
                <rect x="2" y="23" width="2" height="1" fill="#3f2e18" />
                <rect x="20" y="23" width="2" height="1" fill="#3f2e18" />
                
                {/* Wood Grain */}
                <rect x="4" y="20" width="2" height="1" fill="#6d4c21" />
                <rect x="12" y="21" width="3" height="1" fill="#6d4c21" />
                <rect x="18" y="20" width="1" height="1" fill="#6d4c21" />
            </g>
        );

        const PixelBird = ({ color = "#fef3c7", size=24, style }) => (
            <svg viewBox="0 0 16 16" width={size} height={size} className="pixel-art absolute opacity-100" style={style}>
                {/* Body */}
                <rect x="4" y="6" width="8" height="4" fill={color} />
                {/* Head */}
                <rect x="12" y="4" width="2" height="4" fill={color} />
                {/* Beak */}
                <rect x="14" y="5" width="2" height="2" fill="#f59e0b" />
                {/* Wing - Flapping */}
                <rect className="wing-flap" x="6" y="4" width="4" height="3" fill={color} opacity="0.8" />
                {/* Tail */}
                <rect x="0" y="7" width="4" height="2" fill={color} />
                {/* Eye */}
                <rect x="12" y="5" width="1" height="1" fill="#1e293b" />
            </svg>
        );

        const PixelButterfly = ({ color = "#f472b6", size=16, style }) => (
            <svg viewBox="0 0 16 16" width={size} height={size} className="pixel-art absolute opacity-90" style={style}>
                <rect x="2" y="4" width="4" height="4" fill={color} />
                <rect x="10" y="4" width="4" height="4" fill={color} />
                <rect x="7" y="6" width="2" height="6" fill="#1e293b" />
                <rect x="4" y="9" width="2" height="2" fill={color} />
                <rect x="10" y="9" width="2" height="2" fill={color} />
            </svg>
        );

        const PixelBee = ({ size=12, style }) => (
            <svg viewBox="0 0 12 12" width={size} height={size} className="pixel-art absolute opacity-100" style={style}>
                <rect x="2" y="4" width="8" height="4" fill="#fbbf24" />
                <rect x="4" y="4" width="2" height="4" fill="#451a03" />
                <rect x="8" y="4" width="2" height="4" fill="#451a03" />
                <rect x="4" y="2" width="4" height="2" fill="#e2e8f0" opacity="0.6"/>
                <rect x="5" y="5" width="1" height="1" fill="black" opacity="0.5"/>
            </svg>
        );

        // Tall, viny, distinct fruits
        const Plant_Tomato = ({ c, variety }) => {
            let fc = c.fruit;
            if(variety.includes('black') || variety.includes('cherokee')) fc = '#3f0c18';
            if(variety.includes('sun') || variety.includes('orange')) fc = '#f97316';
            if(variety.includes('green')) fc = '#84cc16';
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                    <rect x="11" y="6" width="2" height="8" fill={c.stem} />
                    <rect x="9" y="8" width="2" height="2" fill={c.leafDark} />
                    <rect x="7" y="9" width="2" height="1" fill={c.leafDark} />
                    <rect x="13" y="7" width="2" height="2" fill={c.leafDark} />
                    <rect x="15" y="6" width="2" height="1" fill={c.leafDark} />
                    <rect x="10" y="5" width="4" height="2" fill={c.leafLight} />
                    <rect x="10" y="10" width="2" height="2" fill={fc} />
                    <rect x="13" y="9" width="2" height="2" fill={fc} />
                    <rect x="11" y="4" width="2" height="2" fill={fc} />
                </g>
            );
        };

        // Shrubby, hanging elongated fruits
        const Plant_Pepper = ({ c, variety }) => {
            let fc = c.fruit;
            if(variety.includes('jalapeno') || variety.includes('serrano')) fc = '#15803d';
            if(variety.includes('habanero') || variety.includes('orange')) fc = '#f97316';
            if(variety.includes('purple')) fc = '#581c87';
            if(variety.includes('banana') || variety.includes('wax')) fc = '#fef08a';
            
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                    <rect x="11" y="8" width="2" height="6" fill={c.stem} />
                    <rect x="9" y="8" width="2" height="2" fill={c.leafDark} />
                    <rect x="13" y="9" width="2" height="2" fill={c.leafDark} />
                    <rect x="10" y="5" width="4" height="3" fill={c.leafLight} />
                    <rect x="8" y="10" width="2" height="3" fill={fc} />
                    <rect x="14" y="11" width="2" height="3" fill={fc} />
                </g>
            );
        };

        // Low, wide, ruffly
        const Plant_Leafy = ({ c }) => (
            <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                 <rect x="8" y="12" width="8" height="2" fill={c.leafDark} />
                 <rect x="6" y="10" width="12" height="2" fill={c.leafDark} />
                 <rect x="8" y="8" width="8" height="2" fill={c.leafLight} />
                 <rect x="10" y="6" width="4" height="2" fill={c.leafLight} />
            </g>
        );

        // Upright, thin leaves
        const Plant_Root = ({ c, variety }) => {
            let rootColor = c.root;
            if(variety.includes('beet') || variety.includes('radish')) rootColor = '#be185d';
            if(variety.includes('onion') || variety.includes('garlic')) rootColor = '#fcd34d';
            if(variety.includes('potato')) rootColor = '#d4d4d8';
            
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                     <rect x="11" y="12" width="2" height="2" fill={rootColor} />
                     <rect x="10" y="6" width="1" height="6" fill={c.leafDark} />
                     <rect x="13" y="6" width="1" height="6" fill={c.leafDark} />
                     <rect x="8" y="4" width="1" height="4" fill={c.leafLight} />
                     <rect x="15" y="4" width="1" height="4" fill={c.leafLight} />
                     <rect x="11" y="2" width="2" height="10" fill={c.leafLight} />
                </g>
            );
        };

        // Low spreading, small dots
        const Plant_Berry = ({ c, variety }) => {
            let berryColor = c.fruit;
            if(variety.includes('blue')) berryColor = '#1e3a8a';
            if(variety.includes('black')) berryColor = '#1c1917';
            
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                     <rect x="6" y="11" width="12" height="3" fill={c.leafDark} />
                     <rect x="8" y="9" width="8" height="2" fill={c.leafLight} />
                     <rect x="6" y="13" width="2" height="2" fill={berryColor} />
                     <rect x="16" y="12" width="2" height="2" fill={berryColor} />
                     <rect x="11" y="12" width="2" height="2" fill={berryColor} />
                </g>
            );
        };

        // Bunchy
        const Plant_Herb = ({ c, variety }) => {
            let herbColor = c.leafLight;
            if(variety.includes('lavender')) herbColor = '#a78bfa';
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                     <rect x="11" y="10" width="2" height="4" fill={c.stem} />
                     <rect x="9" y="10" width="2" height="2" fill={c.leafDark} />
                     <rect x="13" y="10" width="2" height="2" fill={c.leafDark} />
                     <rect x="10" y="7" width="2" height="2" fill={herbColor} />
                     <rect x="12" y="8" width="2" height="2" fill={herbColor} />
                     <rect x="8" y="5" width="2" height="2" fill={herbColor} />
                     <rect x="14" y="6" width="2" height="2" fill={herbColor} />
                     <rect x="11" y="4" width="2" height="2" fill={herbColor} />
                </g>
            );
        };

        // Woody trunk, canopy
        const Plant_Tree = ({ c, variety }) => {
             let fc = c.fruitAlt;
             if(variety.includes('mulberry')) fc = '#4c1d95';
             if(variety.includes('cherry')) fc = '#dc2626';
             if(variety.includes('lime')) fc = '#84cc16';
             if(variety.includes('orange') || variety.includes('kumquat')) fc = '#f97316';
             if(variety.includes('apple')) fc = '#ef4444';
             
             return (
                 <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                    <rect x="11" y="8" width="2" height="6" fill="#5c401f" />
                    <rect x="8" y="4" width="8" height="6" fill={c.leafDark} />
                    <rect x="9" y="3" width="6" height="8" fill={c.leafDark} />
                    <rect x="10" y="2" width="4" height="2" fill={c.leafLight} />
                    <rect x="9" y="4" width="2" height="2" fill={c.leafLight} />
                    <rect x="13" y="5" width="2" height="2" fill={c.leafLight} />
                    <rect x="8" y="6" width="1" height="1" fill={fc} />
                    <rect x="15" y="5" width="1" height="1" fill={fc} />
                    <rect x="11" y="5" width="1" height="1" fill={fc} />
                 </g>
             );
        };
        
        // Flower with colorful petals
        const Plant_Flower = ({ c, variety }) => {
            let petalColor = c.fruit; // Default red
            let centerColor = "#fef3c7";
            if (variety.includes('sunflower')) { petalColor = '#eab308'; centerColor = '#451a03'; }
            if (variety.includes('lavender')) { petalColor = '#a855f7'; }
            if (variety.includes('marigold')) { petalColor = '#f97316'; }
            if (variety.includes('white') || variety.includes('jasmine')) petalColor = '#f0fdf4';
            if (variety.includes('hibiscus')) petalColor = '#ec4899';
            if (variety.includes('pansy') || variety.includes('viola')) { petalColor = '#7e22ce'; centerColor = '#facc15'; }
            if (variety.includes('tulip') || variety.includes('rose')) petalColor = '#f43f5e';
            if (variety.includes('orchid')) petalColor = '#d946ef';
            if (variety.includes('zinnia')) petalColor = '#ec4899';
            if (variety.includes('blue')) petalColor = '#3b82f6';
            
            return (
                <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                    <rect x="11" y="10" width="2" height="4" fill={c.stem} />
                    <rect x="9" y="12" width="2" height="2" fill={c.leafDark} />
                    <rect x="13" y="12" width="2" height="2" fill={c.leafDark} />
                    <rect x="10" y="6" width="4" height="4" fill={petalColor} />
                    <rect x="9" y="7" width="6" height="2" fill={petalColor} />
                    <rect x="11" y="5" width="2" height="6" fill={petalColor} />
                    <rect x="11" y="7" width="2" height="2" fill={centerColor} /> 
                </g>
            );
        };
        
        // Cactus / Exotic
        const Plant_Exotic = ({ c, variety }) => {
             let bodyColor = c.leafDark;
             let fruitColor = "#db2777";
             if(variety.includes('pineapple')) { bodyColor = '#d97706'; fruitColor='#fcd34d'; }
             if(variety.includes('banana')) { bodyColor = '#84cc16'; fruitColor='#fef08a'; }
             
             return (
                 <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                    <rect x="10" y="6" width="4" height="8" fill={bodyColor} />
                    <rect x="8" y="8" width="2" height="4" fill={bodyColor} />
                    <rect x="14" y="7" width="2" height="3" fill={bodyColor} />
                    <rect x="10" y="7" width="1" height="1" fill="#fef3c7" opacity="0.5"/>
                    <rect x="13" y="9" width="1" height="1" fill="#fef3c7" opacity="0.5"/>
                    <rect x="11" y="5" width="2" height="2" fill={fruitColor} />
                 </g>
             );
        };

        const Plant_Generic = ({ c }) => (
             <g className="animate-sway" style={{transformOrigin: "12px 14px"}}>
                <rect x="11" y="10" width="2" height="4" fill={c.stem} />
                <rect x="9" y="8" width="2" height="2" fill={c.leafDark} />
                <rect x="13" y="9" width="2" height="2" fill={c.leafDark} />
                <rect x="11" y="6" width="2" height="2" fill={c.leafLight} />
             </g>
        );

        const PlantVisual = ({ name, scale=1, status='healthy' }) => {
            const c = PALETTES[status];
            const lower = name.toLowerCase();
            
            let PlantComp = Plant_Generic;
            if(lower.includes('tomato')) PlantComp = Plant_Tomato;
            else if(lower.includes('pepper')) PlantComp = Plant_Pepper;
            else if(lower.includes('lettuce') || lower.includes('spinach') || lower.includes('chard') || lower.includes('kale') || lower.includes('greens') || lower.includes('cabbage') || lower.includes('broccoli') || lower.includes('cauliflower') || lower.includes('sprout') || lower.includes('bok choy')) PlantComp = Plant_Leafy;
            else if(lower.includes('carrot') || lower.includes('radish') || lower.includes('potato') || lower.includes('root') || lower.includes('ginger') || lower.includes('turmeric') || lower.includes('beet') || lower.includes('onion') || lower.includes('garlic')) PlantComp = Plant_Root;
            else if(lower.includes('berry') || lower.includes('strawberry') || lower.includes('grape') || lower.includes('currant')) PlantComp = Plant_Berry;
            else if(lower.includes('basil') || lower.includes('mint') || lower.includes('oregano') || lower.includes('thyme') || lower.includes('cilantro') || lower.includes('parsley') || lower.includes('chive') || lower.includes('dill') || lower.includes('sage') || lower.includes('lemongrass')) PlantComp = Plant_Herb;
            else if(lower.includes('tree') || lower.includes('mulberry') || lower.includes('lemon') || lower.includes('kumquat') || lower.includes('lime') || lower.includes('apple') || lower.includes('pear') || lower.includes('peach') || lower.includes('cherry') || lower.includes('fig') || lower.includes('orange') || lower.includes('avocado')) PlantComp = Plant_Tree;
            else if(lower.includes('flower') || lower.includes('sunflower') || lower.includes('lavender') || lower.includes('marigold') || lower.includes('petunia') || lower.includes('pansy') || lower.includes('hibiscus') || lower.includes('zinnia') || lower.includes('nasturtium') || lower.includes('rose') || lower.includes('tulip') || lower.includes('orchid') || lower.includes('viola') || lower.includes('snapdragon') || lower.includes('cosmos') || lower.includes('begonia') || lower.includes('lily')) PlantComp = Plant_Flower;
            else if(lower.includes('dragon') || lower.includes('cactus') || lower.includes('pineapple') || lower.includes('banana') || lower.includes('passion')) PlantComp = Plant_Exotic;
            else if(lower.includes('bean') || lower.includes('pea') || lower.includes('cucumber') || lower.includes('squash') || lower.includes('zucchini') || lower.includes('pumpkin') || lower.includes('melon') || lower.includes('eggplant')) PlantComp = Plant_Tomato; // Use viny/bushy tomato model for these
            
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art">
                    <PixelTable />
                    <g transform="translate(0, -2)">
                        <PixelPot />
                        <PlantComp c={c} variety={lower} />
                    </g>
                </svg>
            );
        };

        // --- ICONS ---
        const IconBase = ({ children, className = "", size = 24, color = "currentColor" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Sun = (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const Moon = (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Edit3 = (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>;
        const Droplets = (p) => <IconBase {...p}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.35"/></IconBase>;
        const Utensils = (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Box = (p) => <IconBase {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22.08V12"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const CloudRain = (p) => <IconBase {...p}><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></IconBase>;
        const Thermometer = (p) => <IconBase {...p}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const CalendarIcon = (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;

        const PixelSun = () => <svg viewBox="0 0 24 24" width="64" height="64" className="pixel-art animate-spin-slow"><rect x="8" y="8" width="8" height="8" fill="#fcd34d" /><rect x="10" y="4" width="4" height="2" fill="#f59e0b" /><rect x="10" y="18" width="4" height="2" fill="#f59e0b" /><rect x="4" y="10" width="2" height="4" fill="#f59e0b" /><rect x="18" y="10" width="2" height="4" fill="#f59e0b" /><rect x="6" y="6" width="2" height="2" fill="#f59e0b" /><rect x="16" y="6" width="2" height="2" fill="#f59e0b" /><rect x="6" y="16" width="2" height="2" fill="#f59e0b" /><rect x="16" y="16" width="2" height="2" fill="#f59e0b" /></svg>;
        const PixelMoon = () => <svg viewBox="0 0 24 24" width="50" height="50" className="pixel-art"><rect x="8" y="4" width="6" height="2" fill="#e2e8f0" /><rect x="6" y="6" width="4" height="2" fill="#e2e8f0" /><rect x="4" y="8" width="4" height="8" fill="#e2e8f0" /><rect x="6" y="16" width="4" height="2" fill="#e2e8f0" /><rect x="8" y="18" width="6" height="2" fill="#e2e8f0" /><rect x="12" y="6" width="4" height="12" fill="#94a3b8" /></svg>;
        
        // --- NEW CLOUD SHAPES ---
        const PixelCloud = ({ opacity = 1 }) => (
            <svg viewBox="0 0 32 16" width="64" height="32" className="pixel-art" style={{opacity}}>
                <rect x="8" y="8" width="16" height="6" fill="white" />
                <rect x="4" y="10" width="4" height="4" fill="white" />
                <rect x="24" y="10" width="4" height="4" fill="white" />
                <rect x="8" y="4" width="8" height="4" fill="white" />
                <rect x="16" y="6" width="6" height="2" fill="white" />
            </svg>
        );

        const PixelCloudFluffy = ({ opacity = 1 }) => (
            <svg viewBox="0 0 32 20" width="64" height="40" className="pixel-art" style={{opacity}}>
                <rect x="6" y="8" width="20" height="10" fill="white" />
                <rect x="4" y="10" width="2" height="6" fill="white" />
                <rect x="26" y="10" width="2" height="6" fill="white" />
                <rect x="8" y="4" width="8" height="4" fill="white" />
                <rect x="18" y="6" width="6" height="2" fill="white" />
                <rect x="10" y="2" width="4" height="2" fill="white" />
            </svg>
        );

        const PixelCloudWide = ({ opacity = 1 }) => (
            <svg viewBox="0 0 48 16" width="96" height="32" className="pixel-art" style={{opacity}}>
                <rect x="10" y="8" width="28" height="6" fill="white" />
                <rect x="6" y="10" width="4" height="4" fill="white" />
                <rect x="38" y="10" width="4" height="4" fill="white" />
                <rect x="12" y="4" width="12" height="4" fill="white" />
                <rect x="28" y="6" width="8" height="2" fill="white" />
            </svg>
        );

        // --- ANIMATION ---
        const CelebrationOverlay = ({ plantName }) => (
            <div className="fixed inset-0 z-[120] flex items-center justify-center pointer-events-none bg-black/40 backdrop-blur-sm transition-opacity duration-500">
                <div className="relative flex flex-col items-center">
                    <div className="animate-grow origin-bottom scale-150 mb-6 drop-shadow-2xl">
                        <PlantVisual name={plantName} scale={8} status="healthy" />
                    </div>
                    <div className="animate-pop text-center">
                        <span className="text-3xl font-bold text-[#fef3c7] bg-[#451a03] px-8 py-3 rounded-lg shadow-xl border-4 border-[#78350f] pixel-font tracking-widest">PLANTED!</span>
                    </div>
                </div>
            </div>
        );

        // --- CUSTOM MODALS & TOASTS (Replaces Alert/Confirm) ---
        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-[#f0ebe5] rounded-lg border-4 border-[#451a03] p-6 max-w-sm w-full mx-4 card-shadow animate-pop">
                        <div className="text-[#451a03] text-xl font-bold pixel-font mb-4 text-center tracking-wide">{message}</div>
                        <div className="flex gap-4 justify-center">
                            <button onClick={onCancel} className="px-4 py-2 rounded bg-[#e7e5e4] text-[#57534e] font-bold border-2 border-[#d6d3d1] hover:bg-[#d6d3d1] pixel-font">CANCEL</button>
                            <button onClick={onConfirm} className="wood-btn px-6 py-2 rounded font-bold pixel-font">CONFIRM</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-500 border-red-700' : 'bg-[#451a03] border-[#78350f]';

            return (
                <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 z-[160] ${bgClass} text-[#fef3c7] px-6 py-3 rounded-lg shadow-xl border-2 pixel-font tracking-wide animate-slide-up flex items-center gap-2`}>
                    {type === 'error' ? <AlertTriangle size={18} /> : <div className="text-green-400 text-lg">âœ“</div>}
                    {message}
                </div>
            );
        };
        
        // --- CALENDAR COMPONENT ---
        const GardenCalendar = ({ plants, getWeatherModifier }) => {
             const [forecast, setForecast] = useState([]);
             
             useEffect(() => {
                 const wMod = getWeatherModifier();
                 const nextWeek = [];
                 const today = new Date();
                 today.setHours(0,0,0,0);
                 
                 for(let i=0; i<7; i++) {
                     const currentDay = new Date(today);
                     currentDay.setDate(today.getDate() + i);
                     
                     const dayTasks = [];
                     plants.forEach(p => {
                        // Water calc
                        const wAdjFreq = Math.max(1, Math.round(p.waterFreq * wMod.val));
                        const lastW = new Date(p.lastWatered);
                        // Calculate next due date
                        const nextW = new Date(lastW);
                        nextW.setDate(lastW.getDate() + wAdjFreq);
                        nextW.setHours(0,0,0,0);
                        
                        // If it's overdue (before today) and we are looking at today (i==0), show it
                        if (i === 0 && nextW < today) {
                            dayTasks.push({ plant: p, type: 'water', overdue: true });
                        } else if (nextW.getTime() === currentDay.getTime()) {
                            dayTasks.push({ plant: p, type: 'water', overdue: false });
                        }
                        
                        // Feed calc
                        if (p.fertilizerFreq > 0) {
                            const lastF = new Date(p.lastFertilized);
                            const nextF = new Date(lastF);
                            nextF.setDate(lastF.getDate() + p.fertilizerFreq); // No weather mod for food usually
                            nextF.setHours(0,0,0,0);
                            
                            if (i === 0 && nextF < today) {
                                dayTasks.push({ plant: p, type: 'fert', overdue: true });
                            } else if (nextF.getTime() === currentDay.getTime()) {
                                dayTasks.push({ plant: p, type: 'fert', overdue: false });
                            }
                        }
                     });
                     
                     nextWeek.push({ date: currentDay, tasks: dayTasks });
                 }
                 setForecast(nextWeek);
             }, [plants, getWeatherModifier]);

             return (
                 <div className="bg-[#fdfbf7] border-4 border-[#5c401f] rounded-xl card-shadow p-4 mt-6">
                    <h3 className="text-[#78350f] font-bold pixel-font text-2xl mb-4 flex items-center gap-2 border-b-2 border-[#e7e5e4] pb-2">
                        <CalendarIcon size={24}/> GARDEN FORECAST
                    </h3>
                    <div className="flex gap-2 overflow-x-auto pb-4 library-scroll">
                        {forecast.map((day, idx) => (
                            <div key={idx} className={`flex-shrink-0 w-28 flex flex-col border-2 rounded-lg overflow-hidden ${idx === 0 ? 'border-[#78350f] bg-[#fffbeb]' : 'border-[#d6d3d1] bg-white'}`}>
                                <div className={`p-1 text-center font-bold text-xs uppercase ${idx === 0 ? 'bg-[#78350f] text-[#fef3c7]' : 'bg-[#e7e5e4] text-[#57534e]'}`}>
                                    {idx === 0 ? 'TODAY' : day.date.toLocaleDateString('en-US', {weekday: 'short', month: 'numeric', day: 'numeric'})}
                                </div>
                                <div className="p-2 flex flex-col gap-1 h-32 overflow-y-auto library-scroll">
                                    {day.tasks.length === 0 ? (
                                        <div className="h-full flex items-center justify-center opacity-30">
                                            <span className="text-2xl">ðŸŒ±</span>
                                        </div>
                                    ) : (
                                        day.tasks.map((t, tIdx) => (
                                            <div key={tIdx} className={`text-[10px] p-1 rounded border flex items-center gap-1 ${t.type === 'water' ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-green-50 border-green-200 text-green-800'}`}>
                                                {t.type === 'water' ? <Droplets size={8}/> : <Utensils size={8}/>}
                                                <span className="truncate font-bold">{t.plant.nickname || t.plant.name}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                 </div>
             );
        };

        // --- APP LOGIC ---
        const App = () => {
            const [plants, setPlants] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [filter, setFilter] = useState('all'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [justAddedPlant, setJustAddedPlant] = useState(null);
            const [weather, setWeather] = useState(null);
            const [weatherLoading, setWeatherLoading] = useState(false);
            const [weatherError, setWeatherError] = useState(null);
            const [savedCoords, setSavedCoords] = useState(null);
            
            // System UI State
            const [confirmState, setConfirmState] = useState({ isOpen: false, message: '', onConfirm: null });
            const [toastState, setToastState] = useState(null); // { message, type }

            const fileInputRef = useRef(null);
            
            const [newPlant, setNewPlant] = useState({
                id: null, name: '', nickname: '', location: '', 
                containerMaterial: 'Plastic', containerSize: '3 Gallon', 
                plantedDate: new Date().toISOString().split('T')[0],
                waterFreq: 3, lastWatered: new Date().toISOString().split('T')[0],
                fertilizerFreq: 14, lastFertilized: new Date().toISOString().split('T')[0],
                notes: ''
            });

            useEffect(() => { 
                try { 
                    const saved = localStorage.getItem('balconyTracker_v15'); 
                    if (saved) setPlants(JSON.parse(saved));
                    const coords = localStorage.getItem('garden_coords');
                    if (coords) setSavedCoords(JSON.parse(coords));
                } catch (e) {} 
            }, []);

            useEffect(() => { try { localStorage.setItem('balconyTracker_v15', JSON.stringify(plants)); } catch (e) {} }, [plants]);

            useEffect(() => { if (savedCoords) fetchWeather(savedCoords.latitude, savedCoords.longitude); }, [savedCoords]);

            const showToast = (message, type = 'success') => setToastState({ message, type });

            const fetchWeather = async (lat, lon) => {
                setWeatherLoading(true); setWeatherError(null);
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,is_day&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum&temperature_unit=fahrenheit&timezone=auto`);
                    if(!response.ok) throw new Error("Weather failed");
                    setWeather(await response.json());
                } catch (err) { setWeatherError("Weather Error"); } finally { setWeatherLoading(false); }
            };

            const requestLocation = () => {
                if (!navigator.geolocation) { setWeatherError("Unsupported"); return; }
                setWeatherLoading(true); setWeatherError(null);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        localStorage.setItem('garden_coords', JSON.stringify({ latitude, longitude }));
                        setSavedCoords({ latitude, longitude });
                    },
                    () => { setWeatherError("Denied"); setWeatherLoading(false); }
                );
            };

            const getWeatherIcon = (code) => {
                if (code <= 1) return <Sun size={14} className="text-yellow-400"/>;
                if (code <= 3) return <Sun size={14} className="text-gray-400"/>;
                if (code <= 67) return <CloudRain size={14} className="text-blue-400"/>;
                return <AlertTriangle size={14} className="text-red-400"/>;
            };

            const getDayName = (isoDate) => new Date(isoDate).toLocaleDateString('en-US', { weekday: 'short' });

            // Memoized to prevent calendar refresh loops, but using refs inside useEffect there. 
            // We just need a stable function reference for the calendar component.
            const getWeatherModifier = React.useCallback(() => {
                if (!weather) return { val: 1.0, icon: null };
                const maxTemp = weather.daily.temperature_2m_max[0];
                const precip = weather.daily.precipitation_sum[0];
                // Heat > 85F speeds up drying (0.7x interval)
                if (maxTemp > 85) return { val: 0.7, icon: <Sun size={12} className="text-orange-500 animate-pulse"/> };
                // Rain > 0.2 inch slows down drying (1.5x interval)
                if (precip > 0.2) return { val: 1.5, icon: <CloudRain size={12} className="text-blue-500"/> };
                return { val: 1.0, icon: null };
            }, [weather]);

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(plants));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", "garden_backup.json");
                document.body.appendChild(anchor); anchor.click(); anchor.remove();
                showToast("Garden data exported!");
            };

            const handleImportClick = () => fileInputRef.current.click();

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            setConfirmState({
                                isOpen: true,
                                message: `Restore ${imported.length} plants?`,
                                onConfirm: () => {
                                    setPlants(imported);
                                    setConfirmState({ ...confirmState, isOpen: false });
                                    showToast("Garden restored!");
                                }
                            });
                        }
                    } catch (e) { showToast("Invalid File", 'error'); }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const handleSavePlant = (e) => {
                e.preventDefault(); if (!newPlant.name) return;
                const save = { ...newPlant, id: newPlant.id || Date.now().toString() };
                if (newPlant.id) {
                    setPlants(plants.map(p => p.id === newPlant.id ? save : p));
                    showToast("Pot updated!");
                } else { 
                    setPlants([...plants, save]); 
                    setJustAddedPlant(newPlant.name); 
                    setTimeout(() => setJustAddedPlant(null), 2500); 
                    showToast("New pot added!");
                }
                closeModal();
            };

            const handleDelete = (id) => { 
                setConfirmState({
                    isOpen: true,
                    message: "Compost this pot?",
                    onConfirm: () => {
                        setPlants(plants.filter(p => p.id !== id));
                        setConfirmState({ ...confirmState, isOpen: false });
                        showToast("Pot removed.");
                    }
                });
            };

            const logAction = (id, type) => {
                const today = new Date().toISOString().split('T')[0];
                setPlants(plants.map(p => p.id === id ? (type === 'water' ? { ...p, lastWatered: today } : { ...p, lastFertilized: today }) : p));
                showToast(type === 'water' ? "Thirst quenched!" : "Plant fed!");
            };

            const calculateFrequencies = (basePlant, materialLabel, sizeLabel) => {
                const mat = CONTAINER_MATERIALS.find(m => m.label === materialLabel) || CONTAINER_MATERIALS[0];
                const siz = CONTAINER_SIZES.find(s => s.label === sizeLabel) || CONTAINER_SIZES[3];
                const totalWaterMod = mat.waterMod * siz.waterMod;
                const totalFertMod = mat.fertMod * siz.fertMod;
                const waterFreq = Math.max(1, Math.round(basePlant.waterFreq * totalWaterMod));
                const fertFreq = basePlant.fertilizerFreq === 0 ? 0 : Math.max(7, Math.round(basePlant.fertilizerFreq * totalFertMod));
                return { waterFreq, fertFreq };
            };

            const selectFromLibrary = (libPlant) => {
                const { waterFreq, fertFreq } = calculateFrequencies(libPlant, newPlant.containerMaterial, newPlant.containerSize);
                setNewPlant(prev => ({ 
                    ...prev, name: libPlant.name, waterFreq, fertilizerFreq: fertFreq, notes: libPlant.notes 
                }));
                setSearchTerm('');
            };

            const handleContainerChange = (field, value) => {
                const updatedPlant = { ...newPlant, [field]: value };
                const libEntry = PLANT_LIBRARY.find(p => p.name === newPlant.name);
                if (libEntry) {
                    const { waterFreq, fertFreq } = calculateFrequencies(libEntry, updatedPlant.containerMaterial, updatedPlant.containerSize);
                    updatedPlant.waterFreq = waterFreq;
                    updatedPlant.fertilizerFreq = fertFreq;
                }
                setNewPlant(updatedPlant);
            };

            const openEdit = (plant) => { setNewPlant(plant); setSearchTerm(''); setShowModal(true); };
            const openNew = () => {
                setNewPlant({ 
                    id: null, name: '', nickname: '', location: '', 
                    containerMaterial: 'Plastic', containerSize: '3 Gallon', 
                    plantedDate: new Date().toISOString().split('T')[0],
                    waterFreq: 3, lastWatered: new Date().toISOString().split('T')[0],
                    fertilizerFreq: 14, lastFertilized: new Date().toISOString().split('T')[0],
                    notes: ''
                });
                setSearchTerm(''); setShowModal(true);
            };
            const closeModal = () => setShowModal(false);

            const getStatus = (lastDate, freq) => {
                if (parseInt(freq) === 0) return { daysLeft: 999, isDue: false, weatherIcon: null };
                const wMod = getWeatherModifier(); 
                const adjustedFreq = Math.max(1, Math.round(freq * wMod.val));
                const next = new Date(lastDate); next.setDate(next.getDate() + adjustedFreq); next.setHours(0,0,0,0);
                const today = new Date(); today.setHours(0,0,0,0);
                const daysLeft = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
                return { daysLeft, isDue: daysLeft <= 0, weatherIcon: wMod.icon };
            };

            const filteredPlants = plants.filter(p => filter === 'due' ? (getStatus(p.lastWatered, p.waterFreq).isDue || getStatus(p.lastFertilized, p.fertilizerFreq).isDue) : true);
            const librarySuggestions = searchTerm.length > 0 ? PLANT_LIBRARY.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())) : [];
            const uniqueWisdom = Array.from(new Set(plants.map(p => p.name))).map(name => { const l = PLANT_LIBRARY.find(i => i.name === name); return l ? { name: name, tip: l.tip } : null; }).filter(Boolean);
            const isDay = weather ? weather.current.is_day === 1 : true;
            
            const shelves = [];
            for (let i = 0; i < plants.length; i += 4) { shelves.push(plants.slice(i, i + 4)); }
            if (shelves.length === 0) shelves.push([]);

            return (
                <div className="min-h-screen pb-32">
                    {justAddedPlant && <CelebrationOverlay plantName={justAddedPlant} />}
                    {toastState && <Toast message={toastState.message} type={toastState.type} onClose={() => setToastState(null)} />}
                    <ConfirmModal 
                        isOpen={confirmState.isOpen} 
                        message={confirmState.message} 
                        onConfirm={confirmState.onConfirm} 
                        onCancel={() => setConfirmState({...confirmState, isOpen: false})} 
                    />

                    {/* UPDATED HEADER Z-INDEX to z-50 to stay on top */}
                    <header className="bg-[#1c1917] text-[#e7e5e4] shadow-lg sticky top-0 z-50 border-b-4 border-[#44403c]">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-3xl filter grayscale-[30%]">ðŸŒ¿</span>
                                <div>
                                    <h1 className="text-2xl font-bold leading-none tracking-wide text-[#a8a29e]">BALCONY</h1>
                                    <h1 className="text-xl font-bold leading-none tracking-wide text-[#d97706]">GARDEN</h1>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="bg-[#292524] text-[#a8a29e] p-2 rounded-lg border border-[#44403c] hover:text-[#d6d3d1]" title="Export"><Download size={18} /></button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                <button onClick={handleImportClick} className="bg-[#292524] text-[#a8a29e] p-2 rounded-lg border border-[#44403c] hover:text-[#d6d3d1]" title="Import"><Upload size={18} /></button>
                                <button onClick={openNew} className="wood-btn px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 text-lg transition-transform pixel-font tracking-widest ml-2"><Plus size={18} /> ADD</button>
                            </div>
                        </div>

                        <div className="bg-[#292524] p-2 border-b border-[#44403c]">
                            <div className="max-w-4xl mx-auto">
                                {!weather ? (
                                    <button onClick={requestLocation} className="w-full text-xs text-[#a8a29e] hover:text-white flex items-center justify-center gap-2 bg-[#44403c] px-3 py-2 rounded-sm border border-[#57534e] pixel-font">
                                        <MapPin size={14} /> ENABLE WEATHER
                                    </button>
                                ) : (
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center justify-between overflow-x-auto pb-1 gap-2">
                                            <div className="flex flex-col items-center p-2 bg-[#3f3f46] rounded-sm border border-[#52525b] min-w-[70px]">
                                                <span className="text-[10px] text-[#a1a1aa] font-bold">NOW</span>
                                                <span className="text-xl font-bold text-[#f59e0b] pixel-font">{Math.round(weather.current.temperature_2m)}Â°</span>
                                                {getWeatherIcon(weather.daily.weathercode[0])}
                                            </div>
                                            {weather.daily.time.slice(1).map((day, idx) => (
                                                <div key={idx} className="flex flex-col items-center p-1 min-w-[50px] border-r border-[#44403c] last:border-0">
                                                    <span className="text-[10px] text-[#71717a] font-bold uppercase">{getDayName(day)}</span>
                                                    <div className="my-1">{getWeatherIcon(weather.daily.weathercode[idx+1])}</div>
                                                    <span className="text-xs text-[#d4d4d8] font-mono">{Math.round(weather.daily.temperature_2m_max[idx+1])}Â°</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto p-4 space-y-6">
                        
                        {/* VISUAL GARDEN */}
                        <div className={`rounded-xl card-shadow overflow-hidden border-4 border-[#451a03] relative min-h-[40vh] flex flex-col transition-colors duration-2000 ${isDay ? 'bg-gradient-to-b from-sky-400 via-sky-200 to-amber-100' : 'bg-gradient-to-b from-slate-900 via-indigo-950 to-purple-900'}`}>
                            
                            <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden">
                                <div className="absolute top-6 right-6 transition-all duration-1000 z-10">
                                    {isDay ? <PixelSun /> : <PixelMoon />}
                                </div>
                                {!isDay && (
                                    <>
                                        <div className="absolute top-10 left-10 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '0.2s'}}></div>
                                        <div className="absolute top-20 left-1/3 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '0.5s'}}></div>
                                        <div className="absolute top-5 right-1/4 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '1s'}}></div>
                                    </>
                                )}
                                {isDay && (
                                    <>
                                        {/* === CLOUD OVERLOAD === */}
                                        
                                        {/* --- Layer 1: Background (Slowest, Smallest, Low Opacity) --- */}
                                        <div className="absolute top-12 left-[-10%] animate-drift-slower opacity-40" style={{transform: 'scale(1.2)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-24 left-[-60%] animate-drift-slower opacity-30" style={{animationDelay: '40s', transform: 'scale(1.0)'}}><PixelCloud /></div>
                                        <div className="absolute top-5 left-[-35%] animate-drift-slower opacity-40" style={{animationDelay: '80s', transform: 'scale(1.3)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-28 left-[-85%] animate-drift-slower opacity-30" style={{animationDelay: '10s', transform: 'scale(1.1)'}}><PixelCloud /></div>
                                        <div className="absolute top-2 left-[-90%] animate-drift-slower opacity-40" style={{animationDelay: '120s', transform: 'scale(1.4)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-16 left-[-20%] animate-drift-slower opacity-35" style={{animationDelay: '150s', transform: 'scale(1.2)'}}><PixelCloudFluffy /></div>

                                        {/* --- Layer 2: Midground (Medium Speed, Medium Size) --- */}
                                        <div className="absolute top-8 left-[-30%] animate-drift-slow opacity-70" style={{animationDelay: '10s', transform: 'scale(3.0)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-32 left-[-80%] animate-drift-slow opacity-60" style={{animationDelay: '60s', transform: 'scale(2.5)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-16 left-[-10%] animate-drift opacity-65" style={{animationDelay: '90s', transform: 'scale(2.2)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-4 left-[-50%] animate-drift-slow opacity-70" style={{animationDelay: '25s', transform: 'scale(2.4)'}}><PixelCloud /></div>
                                        <div className="absolute top-20 left-[-75%] animate-drift opacity-65" style={{animationDelay: '45s', transform: 'scale(2.8)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-10 left-[-5%] animate-drift-slow opacity-60" style={{animationDelay: '110s', transform: 'scale(2.0)'}}><PixelCloud /></div>

                                        {/* --- Layer 3: Foreground (Fastest, Largest, Fluffiest) --- */}
                                        <div className="absolute top-4 left-[-20%] animate-drift opacity-90" style={{animationDelay: '20s', transform: 'scale(6.0)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-20 left-[-50%] animate-drift-fast opacity-85" style={{animationDelay: '5s', transform: 'scale(5.0)'}}><PixelCloud /></div>
                                        <div className="absolute top-10 left-[-90%] animate-drift opacity-90" style={{animationDelay: '30s', transform: 'scale(5.5)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-2 left-[-40%] animate-drift-fast opacity-80" style={{animationDelay: '15s', transform: 'scale(4.5)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-24 left-[-70%] animate-drift opacity-85" style={{animationDelay: '50s', transform: 'scale(4.8)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-6 left-[-15%] animate-drift-fast opacity-80" style={{animationDelay: '70s', transform: 'scale(5.2)'}}><PixelCloud /></div>
                                        
                                        {/* === WILDLIFE === */}
                                        
                                        {/* Birds - Heavy Traffic, Crossing Right to Left */}
                                        {/* Flock 1 */}
                                        <div className="absolute top-12 left-0 crossing-reverse-med" style={{animationDelay: '-5s'}}>
                                            <div className="local-fly"><PixelBird color="#451a03" size={24} /></div> {/* Sparrow */}
                                        </div>
                                        <div className="absolute top-10 left-[-90%] animate-drift opacity-90" style={{animationDelay: '30s', transform: 'scale(5.5)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-2 left-[-40%] animate-drift-fast opacity-80" style={{animationDelay: '15s', transform: 'scale(4.5)'}}><PixelCloudFluffy /></div>
                                        <div className="absolute top-24 left-[-70%] animate-drift opacity-85" style={{animationDelay: '50s', transform: 'scale(4.8)'}}><PixelCloudWide /></div>
                                        <div className="absolute top-6 left-[-15%] animate-drift-fast opacity-80" style={{animationDelay: '70s', transform: 'scale(5.2)'}}><PixelCloud /></div>
                                        
                                        {/* === WILDLIFE === */}
                                        
                                        {/* Birds - Crossing Right to Left (Face Left) */}
                                        {/* Note: Transform flip applied to PixelBird to avoid conflict with drift animation */}
                                        
                                        <div className="absolute top-12 left-0 crossing-reverse-med" style={{animationDelay: '-5s'}}>
                                            <div className="local-fly">
                                                <PixelBird color="#451a03" size={24} style={{ transform: 'scaleX(-1)' }} />
                                            </div> 
                                        </div>

                                        <div className="absolute top-24 left-0 crossing-reverse-slow" style={{animationDelay: '-25s'}}>
                                            <div className="local-fly-slow">
                                                <PixelBird color="#ef4444" size={28} style={{ transform: 'scaleX(-1)' }} />
                                            </div> 
                                        </div>
                                        
                                        <div className="absolute top-8 left-0 crossing-reverse-fast" style={{animationDelay: '-15s'}}>
                                            <div className="local-fly">
                                                <PixelBird color="#3b82f6" size={26} style={{ transform: 'scaleX(-1)' }} />
                                            </div> 
                                        </div>
                                        
                                        <div className="absolute top-5 left-0 crossing-reverse-slow" style={{animationDelay: '-45s'}}>
                                            <div className="local-fly-slow">
                                                <PixelBird color="#171717" size={32} style={{ transform: 'scaleX(-1)' }} />
                                            </div> 
                                        </div>

                                        {/* Insects - Reduced count, Slower, "Stop and Check" behavior */}
                                        
                                        {/* Butterfly 1 - Checks early plants */}
                                        <div className="absolute top-40 left-[-50px] visiting-early" style={{animationDelay: '2s'}}>
                                            <div className="local-flutter"><PixelButterfly color="#f472b6" size={20} /></div>
                                        </div>
                                        
                                        {/* Butterfly 2 - Checks late plants */}
                                        <div className="absolute top-48 left-[-50px] visiting-late" style={{animationDelay: '25s'}}>
                                            <div className="local-flutter"><PixelButterfly color="#a78bfa" size={24} /></div>
                                        </div>

                                        {/* Bee - Checks early plants, lower down */}
                                        <div className="absolute top-52 left-[-20px] visiting-early" style={{animationDelay: '15s'}}>
                                            <div className="local-buzz"><PixelBee size={14} /></div>
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="absolute top-6 left-0 right-0 text-center z-10">
                                <h3 className="text-[#78350f] font-bold pixel-font text-3xl mb-1 opacity-90 bg-[#f0ebe5]/90 mx-auto w-fit px-6 py-1 rounded-sm shadow-sm border-2 border-[#78350f]/20">MY PLOT</h3>
                            </div>
                            
                            {/* SHELVES - Reduced bottom padding to lower the platform onto the floor */}
                            <div className="pt-32 pb-12 px-4 relative z-10 flex flex-col gap-8 items-center w-full justify-end flex-grow">
                                {shelves.map((shelfPlants, shelfIdx) => (
                                    <div key={shelfIdx} className="relative w-full max-w-md flex flex-col items-center">
                                        <div className="flex items-end justify-center gap-2 sm:gap-6 w-full px-2 z-10 pb-[2px]">
                                            {shelfPlants.length === 0 && shelfIdx === 0 && <span className="text-white/80 text-lg mb-4 pixel-font animate-pulse">Empty plot... plant something!</span>}
                                            {shelfPlants.map((plant, idx) => {
                                                const water = getStatus(plant.lastWatered, plant.waterFreq);
                                                const food = getStatus(plant.lastFertilized, plant.fertilizerFreq);
                                                let status = 'healthy';
                                                if (water.isDue) status = 'dry'; else if (food.isDue) status = 'hungry';
                                                return (
                                                    <div key={plant.id} className="flex-shrink-0 flex flex-col items-center group relative cursor-help filter drop-shadow-xl transition-all duration-300 hover:scale-110">
                                                        <div onClick={() => openEdit(plant)} className="cursor-pointer hover:scale-105 transition-transform"><PlantVisual name={plant.name} scale={3} status={status} /></div>
                                                        <div className="absolute bottom-full mb-2 hidden group-hover:block bg-slate-900 text-slate-100 text-xs px-2 py-1 rounded-sm border border-slate-700 whitespace-nowrap z-20 pixel-font shadow-lg">
                                                            {plant.nickname || plant.name}
                                                            {status === 'dry' && <span className="block text-red-400 text-[10px]">THIRSTY</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="w-full h-4 bg-[#5c401f] border-t-4 border-[#3f2e18] rounded-sm shadow-lg relative"></div>
                                    </div>
                                ))}
                                
                                {/* FLOOR - Reduced height to h-16 (was h-32) */}
                                <div className="absolute bottom-0 w-full h-16 bg-[#78350f] border-t-8 border-[#451a03] pixel-art" style={{backgroundImage: 'linear-gradient(45deg, #451a03 25%, transparent 25%, transparent 75%, #451a03 75%, #451a03), linear-gradient(45deg, #451a03 25%, transparent 25%, transparent 75%, #451a03 75%, #451a03)', backgroundSize: '20px 20px', backgroundPosition: '0 0, 10px 10px', opacity: 0.9}}></div>
                            </div>
                        </div>

                        {/* CALENDAR SECTION */}
                        <GardenCalendar plants={plants} getWeatherModifier={getWeatherModifier} />

                        <div className="flex gap-2 bg-[#292524] p-1 rounded-lg border border-[#44403c]">
                            <button onClick={() => setFilter('all')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition-colors pixel-font tracking-wide ${filter === 'all' ? 'bg-[#57534e] text-[#f5f5f4] border border-[#78716c]' : 'text-[#a8a29e] hover:bg-[#44403c]'}`}>FULL GARDEN</button>
                            <button onClick={() => setFilter('due')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition-colors pixel-font tracking-wide ${filter === 'due' ? 'bg-[#78350f] text-[#fef3c7] border border-[#92400e]' : 'text-[#a8a29e] hover:bg-[#44403c]'}`}>NEEDS CARE</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {filteredPlants.length === 0 && <div className="col-span-full text-center py-12 text-[#57534e]"><Box size={48} className="mx-auto opacity-50 mb-2"/><p className="pixel-font text-xl">No pots found.</p></div>}
                            {filteredPlants.map(plant => {
                                const water = getStatus(plant.lastWatered, plant.waterFreq);
                                const food = getStatus(plant.lastFertilized, plant.fertilizerFreq);
                                let status = 'healthy';
                                if (water.isDue) status = 'dry'; else if (food.isDue) status = 'hungry';

                                return (
                                    <div key={plant.id} className="bg-[#f0ebe5] rounded-xl card-shadow overflow-hidden relative border-2 border-[#a8a29e]">
                                        <div className="absolute top-2 right-2 flex gap-1">
                                             <button onClick={() => openEdit(plant)} className="p-1.5 text-[#78716c] hover:text-[#292524] rounded-sm hover:bg-[#e7e5e4]"><Edit3 size={16} /></button>
                                             <button onClick={() => handleDelete(plant.id)} className="p-1.5 text-[#78716c] hover:text-[#7f1d1d] rounded-sm hover:bg-[#fecaca]"><Trash2 size={16} /></button>
                                        </div>
                                        <div className="p-4">
                                            <div className="flex gap-3 mb-4">
                                                <div onClick={() => openEdit(plant)} className="shrink-0 pt-1 filter drop-shadow-sm cursor-pointer hover:scale-105 transition-transform"><PlantVisual name={plant.name} scale={2} status={status} /></div>
                                                <div className="pr-14">
                                                    {plant.nickname ? (
                                                        <>
                                                            <h2 className="text-xl font-bold text-[#292524] leading-tight pixel-font tracking-wide">{plant.nickname}</h2>
                                                            <p className="text-xs text-[#57534e] font-bold uppercase tracking-wider">{plant.name}</p>
                                                        </>
                                                    ) : (
                                                        <h2 className="text-xl font-bold text-[#292524] leading-tight pixel-font tracking-wide">{plant.name}</h2>
                                                    )}
                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                        <span className="bg-[#e7e5e4] text-[#57534e] text-[10px] px-2 py-0.5 rounded-sm border border-[#d6d3d1] font-bold uppercase pixel-font truncate max-w-[100px]">{plant.containerMaterial}</span>
                                                        <span className="bg-[#e7e5e4] text-[#57534e] text-[10px] px-2 py-0.5 rounded-sm border border-[#d6d3d1] font-bold uppercase pixel-font truncate max-w-[100px]">{plant.containerSize}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className={`p-2.5 rounded-lg border-2 flex flex-col justify-between ${water.isDue ? 'bg-[#eff6ff] border-[#60a5fa]' : 'bg-[#fafaf9] border-[#d6d3d1]'}`}>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-[10px] font-black uppercase text-[#2563eb] pixel-font tracking-wider">Water</span>
                                                        {water.isDue && <div className="w-2 h-2 rounded-sm bg-[#3b82f6] animate-pulse"></div>}
                                                    </div>
                                                    <div className="mb-2 pixel-font text-lg leading-none flex items-center gap-2">
                                                        {water.isDue ? <span className="text-[#1d4ed8] font-bold">DRY!</span> : <span className="text-[#78716c]">{water.daysLeft} days</span>}
                                                        {water.weatherIcon}
                                                    </div>
                                                    <button onClick={() => logAction(plant.id, 'water')} className="w-full bg-[#dbeafe] hover:bg-[#bfdbfe] text-[#1e40af] text-xs font-bold py-1.5 rounded-sm border border-[#93c5fd] transition-colors flex items-center justify-center gap-1 pixel-font"><Droplets size={12}/> WATERED</button>
                                                </div>
                                                <div className={`p-2.5 rounded-lg border-2 flex flex-col justify-between ${food.isDue ? 'bg-[#f0fdf4] border-[#4ade80]' : 'bg-[#fafaf9] border-[#d6d3d1]'}`}>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-[10px] font-black uppercase text-[#16a34a] pixel-font tracking-wider">Feed</span>
                                                        {food.isDue && <div className="w-2 h-2 rounded-sm bg-[#22c55e] animate-pulse"></div>}
                                                    </div>
                                                    <div className="mb-2 pixel-font text-lg leading-none">
                                                        {food.isDue ? <span className="text-[#15803d] font-bold">HUNGRY!</span> : <span className="text-[#78716c]">{food.daysLeft} days</span>}
                                                    </div>
                                                    <button onClick={() => logAction(plant.id, 'food')} className="w-full bg-[#dcfce7] hover:bg-[#bbf7d0] text-[#166534] text-xs font-bold py-1.5 rounded-sm border border-[#86efac] transition-colors flex items-center justify-center gap-1 pixel-font"><Utensils size={12}/> FED</button>
                                                </div>
                                            </div>
                                            {plant.notes && <div className="mt-3 pt-2 border-t border-[#d6d3d1] text-xs text-[#57534e] font-mono">"{plant.notes}"</div>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {uniqueWisdom.length > 0 && (
                            <div className="bg-[#fef3c7] border-4 border-[#d97706] rounded-xl p-4 card-shadow">
                                <h3 className="text-lg font-bold text-[#92400e] mb-3 flex items-center gap-2 pixel-font tracking-wider"><BookOpen size={20}/> ALMANAC WISDOM</h3>
                                <div className="space-y-2 font-mono text-sm text-[#78350f]">
                                    {uniqueWisdom.map((item, idx) => <div key={idx} className="flex gap-2"><span className="font-bold uppercase shrink-0">[{item.name}]:</span><span>{item.tip}</span></div>)}
                                </div>
                            </div>
                        )}
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-auto bg-[#1c1917]/80 backdrop-blur-sm">
                            <div className="bg-[#f0ebe5] w-full max-w-md h-[85vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-xl overflow-hidden card-shadow border-t-4 sm:border-4 border-[#44403c] flex flex-col relative animate-slide-up">
                                <div className="bg-[#292524] p-4 flex justify-between items-center border-b-4 border-[#44403c] shrink-0">
                                    <h3 className="font-bold text-xl text-[#d6d3d1] pixel-font tracking-widest">{newPlant.id ? 'EDIT POT' : 'NEW POT'}</h3>
                                    <button onClick={closeModal}><X size={24} className="text-[#a8a29e] hover:text-[#f5f5f4]" /></button>
                                </div>
                                <div className="overflow-y-auto p-6 space-y-5 flex-grow">
                                    {!newPlant.id && (
                                        <div className="relative group z-30">
                                            <div className="flex items-center border-2 border-[#a8a29e] rounded-sm p-2 bg-[#e7e5e4] focus-within:border-[#78350f] transition-colors">
                                                <Search size={20} className="text-[#78716c] mr-2" />
                                                <input type="text" placeholder="SEARCH ALMANAC..." className="w-full bg-transparent outline-none text-[#292524] placeholder-[#a8a29e] font-bold pixel-font tracking-wider" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                            </div>
                                            {librarySuggestions.length > 0 && (
                                                <ul className="absolute left-0 right-0 mt-2 bg-[#f0ebe5] border-2 border-[#44403c] rounded-sm shadow-xl max-h-48 overflow-y-auto library-scroll z-50">
                                                    {librarySuggestions.map((plant, idx) => (
                                                        <li key={idx} onClick={() => selectFromLibrary(plant)} className="p-2 hover:bg-[#d6d3d1] cursor-pointer border-b border-[#d6d3d1] last:border-0">
                                                            <div className="flex items-center gap-3">
                                                                <PlantVisual name={plant.name} scale={1.2} status="healthy" />
                                                                <div>
                                                                    <div className="font-bold text-[#292524] pixel-font tracking-wide">{plant.name}</div>
                                                                    <div className="text-[10px] text-[#57534e] uppercase font-bold tracking-wider font-mono">Water Base: {plant.waterFreq}d â€¢ Feed Base: {plant.fertilizerFreq}d</div>
                                                                </div>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    )}
                                    <form onSubmit={handleSavePlant} className="space-y-4 font-mono">
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Plant Type</label>
                                                <input type="text" required className="w-full border-b-2 border-[#a8a29e] p-2 focus:border-[#78350f] outline-none text-lg font-bold text-[#292524] bg-transparent pixel-font" value={newPlant.name} onChange={(e) => setNewPlant({...newPlant, name: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Nickname</label>
                                                <input type="text" placeholder="e.g. 'Big Bertha'" className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-[#e7e5e4] text-slate-900 focus:bg-white focus:border-[#78350f] outline-none transition-colors font-bold" value={newPlant.nickname} onChange={(e) => setNewPlant({...newPlant, nickname: e.target.value})} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Location</label>
                                                    <input type="text" placeholder="e.g. Railing" className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-[#e7e5e4] text-slate-900 font-bold" value={newPlant.location} onChange={(e) => setNewPlant({...newPlant, location: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Pot Material</label>
                                                    <select className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-white text-slate-900 font-bold" value={newPlant.containerMaterial} onChange={(e) => handleContainerChange('containerMaterial', e.target.value)}>
                                                        {CONTAINER_MATERIALS.map((opt, idx) => <option key={idx} value={opt.label}>{opt.label}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Pot Size</label>
                                                <select className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-white text-slate-900 font-bold" value={newPlant.containerSize} onChange={(e) => handleContainerChange('containerSize', e.target.value)}>
                                                    {CONTAINER_SIZES.map((opt, idx) => <option key={idx} value={opt.label}>{opt.label}</option>)}
                                                </select>
                                            </div>
                                            <div className="bg-[#dbeafe] p-3 rounded-lg border-2 border-[#93c5fd]">
                                                <div className="flex items-center gap-2 mb-2 text-[#1e40af] font-bold text-xs uppercase tracking-wide pixel-font">
                                                    <Droplets size={14} /> Water Schedule
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <div className="flex items-center bg-white rounded-sm border border-[#93c5fd] px-2">
                                                        <input type="number" min="1" className="w-12 p-2 text-center font-bold text-[#1e40af] outline-none pixel-font text-lg" value={newPlant.waterFreq} onChange={(e) => setNewPlant({...newPlant, waterFreq: e.target.value})} />
                                                        <span className="text-xs text-[#3b82f6] font-bold mr-2 pixel-font">DAYS</span>
                                                    </div>
                                                    <div className="flex-grow text-right">
                                                        <label className="text-[10px] text-[#3b82f6] font-bold block mb-1 pixel-font">LAST WATERED</label>
                                                        <input type="date" className="border border-[#93c5fd] rounded-sm p-1 text-xs text-[#1e40af] font-bold bg-white font-mono" value={newPlant.lastWatered} onChange={(e) => setNewPlant({...newPlant, lastWatered: e.target.value})} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-[#dcfce7] p-3 rounded-lg border-2 border-[#86efac]">
                                                <div className="flex items-center gap-2 mb-2 text-[#166534] font-bold text-xs uppercase tracking-wide pixel-font">
                                                    <Utensils size={14} /> Feed Schedule
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <div className="flex items-center bg-white rounded-sm border border-[#86efac] px-2">
                                                        <input type="number" min="0" className="w-12 p-2 text-center font-bold text-[#166534] outline-none pixel-font text-lg" value={newPlant.fertilizerFreq} onChange={(e) => setNewPlant({...newPlant, fertilizerFreq: e.target.value})} />
                                                        <span className="text-xs text-[#22c55e] font-bold mr-2 pixel-font">DAYS</span>
                                                    </div>
                                                    <div className="flex-grow text-right">
                                                        <label className="text-[10px] text-[#22c55e] font-bold block mb-1 pixel-font">LAST FED</label>
                                                        <input type="date" className="border border-[#86efac] rounded-sm p-1 text-xs text-[#166534] font-bold bg-white font-mono" value={newPlant.lastFertilized} onChange={(e) => setNewPlant({...newPlant, lastFertilized: e.target.value})} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Notes</label>
                                                <textarea className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm h-20 resize-none bg-[#e7e5e4] text-slate-900 font-mono" value={newPlant.notes} onChange={(e) => setNewPlant({...newPlant, notes: e.target.value})}></textarea>
                                            </div>
                                            <div className="pb-6">
                                                <button type="submit" className="w-full wood-btn py-3 rounded-sm text-xl pixel-font tracking-widest flex justify-center items-center gap-2">
                                                    <Save size={20} /> PLANT IT!
                                                </button>
                                            </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
