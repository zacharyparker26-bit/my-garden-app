<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Balcony Garden Manager</title>
    
    <!-- MOBILE APP CONFIGURATION -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/628/628283.png">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQmFsY29ueSBHYXJkZW4iLCJzaG9ydF9uYW1lIjoiR2FyZGVuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzJmM2UzMCIsInRoZW1lX2NvbG9yIjoiIzJmM2UzMCIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi82MjgvNjI4MjgzLnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #fdfbf7; 
            --accent-wood: #78350f;
        }
        body {
            background-color: var(--bg-color);
            font-family: 'Nunito', sans-serif;
            color: #e2e8f0;
            overscroll-behavior-y: none;
        }
        h1, h2, h3, .pixel-font { font-family: 'VT323', monospace; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-shadow { box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.3); border-bottom: 3px solid #0f172a; border-right: 3px solid #0f172a; }
        
        .wood-btn {
            background-color: #92400e;
            border: 2px solid #451a03;
            border-bottom-width: 4px;
            color: #fef3c7;
            text-shadow: 1px 1px 0 #451a03;
        }
        .wood-btn:hover { background-color: #b45309; }
        .wood-btn:active { transform: translateY(2px); border-bottom-width: 2px; }

        .library-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .library-scroll::-webkit-scrollbar-track { background: #334155; }
        .library-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
        
        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        @keyframes drift { from { transform: translateX(-150%); } to { transform: translateX(600%); } }
        @keyframes growUp { 0% { transform: scaleY(0); opacity: 0; } 100% { transform: scaleY(1); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes sway { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-twinkle { animation: twinkle 3s ease-in-out infinite; }
        .animate-drift { animation: drift 80s linear infinite; }
        .animate-drift-fast { animation: drift 40s linear infinite; }
        .animate-drift-slow { animation: drift 120s linear infinite; }
        .animate-grow { transform-origin: bottom center; animation: growUp 0.8s ease-out forwards; }
        .animate-pop { animation: popIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-sway { transform-origin: bottom center; animation: sway 3s ease-in-out infinite; }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }
        
        .pixel-art { image-rendering: pixelated; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- POT MODIFIERS ---
        // Lower Mod = Dries Faster (Water More Often)
        const CONTAINER_MATERIALS = [
            { label: "Plastic", waterMod: 1.0, fertMod: 1.0 },
            { label: "Terra Cotta (Clay)", waterMod: 0.6, fertMod: 0.8 }, 
            { label: "Fabric / Grow Bag", waterMod: 0.65, fertMod: 0.7 }, 
            { label: "Ceramic (Glazed)", waterMod: 1.1, fertMod: 1.0 },
            { label: "Self-Watering", waterMod: 1.6, fertMod: 1.2 }, 
            { label: "Wood Box", waterMod: 1.1, fertMod: 1.0 },
            { label: "Metal", waterMod: 0.9, fertMod: 1.0 } 
        ];

        // Smaller = Dries Faster
        const CONTAINER_SIZES = [
            { label: "Small (< 1 Gal)", waterMod: 0.5, fertMod: 0.9 }, 
            { label: "1 Gallon", waterMod: 0.7, fertMod: 0.9 },
            { label: "2 Gallon", waterMod: 0.8, fertMod: 0.95 },
            { label: "3 Gallon", waterMod: 1.0, fertMod: 1.0 }, // Baseline
            { label: "4 Gallon", waterMod: 1.1, fertMod: 1.0 },
            { label: "5 Gallon", waterMod: 1.2, fertMod: 1.05 },
            { label: "7 Gallon", waterMod: 1.35, fertMod: 1.1 },
            { label: "10 Gallon", waterMod: 1.5, fertMod: 1.2 }
        ];

        // --- PLANT LIBRARY ---
        // waterFreq: Baseline days for 3 Gal Plastic Pot
        const PLANT_LIBRARY = [
            // Herbs
            { name: "Basil (Genovese)", type: "herb", waterFreq: 3, fertilizerFreq: 14, notes: "Pinch flowers.", tip: "Harvest often to prevent bolting." },
            { name: "Basil (Thai)", type: "herb", waterFreq: 3, fertilizerFreq: 14, notes: "Spicier flavor.", tip: "Great for heat." },
            { name: "Chives", type: "grass", waterFreq: 4, fertilizerFreq: 30, notes: "Hardy perennial.", tip: "Divide clumps every 2-3 years." },
            { name: "Cilantro", type: "herb", waterFreq: 3, fertilizerFreq: 14, notes: "Bolts in heat.", tip: "Plant seeds every 2 weeks." },
            { name: "Mint (Chocolate)", type: "herb", waterFreq: 2, fertilizerFreq: 30, notes: "Peppermint scent.", tip: "Keep in a pot! Invasive." },
            { name: "Mint (Mojito)", type: "herb", waterFreq: 2, fertilizerFreq: 30, notes: "Invasive roots!", tip: "Re-pot annually." },
            { name: "Oregano", type: "herb", waterFreq: 5, fertilizerFreq: 30, notes: "Drought tolerant.", tip: "Best flavor before flowering." },
            { name: "Parsley", type: "herb", waterFreq: 3, fertilizerFreq: 21, notes: "Biennial.", tip: "Taproot needs deep pot." },
            { name: "Rosemary", type: "bush", waterFreq: 7, fertilizerFreq: 0, notes: "Hates wet feet.", tip: "Never overwater." },
            { name: "Thyme", type: "herb", waterFreq: 5, fertilizerFreq: 0, notes: "Low maint.", tip: "Trim often." },
            // Veg
            { name: "Lettuce (Leaf)", type: "leafy", waterFreq: 2, fertilizerFreq: 14, notes: "Shallow roots.", tip: "Harvest outer leaves." },
            { name: "Spinach", type: "leafy", waterFreq: 2, fertilizerFreq: 14, notes: "Cold crop.", tip: "Bolts in heat." },
            { name: "Swiss Chard", type: "leafy", waterFreq: 3, fertilizerFreq: 21, notes: "Heat tolerant.", tip: "Harvest stalks from outside." },
            { name: "Pepper (Bell)", type: "pepper", waterFreq: 3, fertilizerFreq: 14, notes: "Heavy feeder.", tip: "Needs calcium." },
            { name: "Pepper (Jalapeno)", type: "pepper", waterFreq: 4, fertilizerFreq: 14, notes: "Mild heat.", tip: "Less water = hotter peppers." },
            { name: "Pepper (Thai)", type: "pepper", waterFreq: 3, fertilizerFreq: 14, notes: "Very hot.", tip: "Dry for spice flakes." },
            { name: "Tomato (Cherry)", type: "tomato", waterFreq: 1, fertilizerFreq: 14, notes: "Thirsty.", tip: "Prune suckers." },
            { name: "Tomato (Black Cherry)", type: "tomato", waterFreq: 1, fertilizerFreq: 14, notes: "Heirloom dark.", tip: "Complex, smoky flavor." },
            { name: "Tomato (Roma)", type: "tomato", waterFreq: 2, fertilizerFreq: 14, notes: "Determinate.", tip: "Great for sauces." },
            { name: "Potato (Yukon Gold)", type: "root", waterFreq: 3, fertilizerFreq: 14, notes: "Hill soil.", tip: "Harvest when tops die back." },
            { name: "Potato (Russet)", type: "root", waterFreq: 3, fertilizerFreq: 14, notes: "Deep container.", tip: "Needs lots of soil depth." },
            { name: "Carrots", type: "root", waterFreq: 3, fertilizerFreq: 21, notes: "Sandy soil.", tip: "Thin seedlings ruthlessly." },
            { name: "Radishes", type: "root", waterFreq: 2, fertilizerFreq: 0, notes: "Fast crop.", tip: "Spicy in hot weather." },
            { name: "Zucchini", type: "bush", waterFreq: 1, fertilizerFreq: 14, notes: "Heavy feeder.", tip: "Hand pollination helps." },
            // Fruits & Berries
            { name: "Strawberry (June)", type: "berry", waterFreq: 2, fertilizerFreq: 14, notes: "One big crop.", tip: "Keep fruit off soil." },
            { name: "Strawberry (Alpine)", type: "berry", waterFreq: 2, fertilizerFreq: 21, notes: "Small & sweet.", tip: "Tolerates shade." },
            { name: "Raspberry (Dwarf)", type: "bush", waterFreq: 2, fertilizerFreq: 30, notes: "Container variety.", tip: "Prune old canes." },
            { name: "Blackberry (Dwarf)", type: "bush", waterFreq: 3, fertilizerFreq: 30, notes: "Thornless.", tip: "Needs full sun." },
            { name: "Blueberry (Bush)", type: "bush", waterFreq: 2, fertilizerFreq: 30, notes: "Acidic soil!", tip: "Use azalea fertilizer." },
            { name: "Fig (Petite)", type: "tree", waterFreq: 3, fertilizerFreq: 30, notes: "Restrict roots.", tip: "Loves heat." },
            { name: "Mulberry (Dwarf)", type: "tree", waterFreq: 3, fertilizerFreq: 30, notes: "Fast grower.", tip: "Prune to keep small." },
            { name: "Cherry (Dwarf)", type: "tree", waterFreq: 4, fertilizerFreq: 60, notes: "Self-pollinating.", tip: "Needs winter chill." },
            { name: "Kumquat", type: "tree", waterFreq: 3, fertilizerFreq: 30, notes: "Eat skin & all.", tip: "Heavy feeder." },
            { name: "Lemon (Meyer)", type: "tree", waterFreq: 3, fertilizerFreq: 30, notes: "Citrus food.", tip: "Bring indoors in winter." }
        ];

        const PALETTES = {
            healthy: { stem: '#4d7c0f', leafLight: '#4ade80', leafDark: '#15803d', fruit: '#dc2626', fruitAlt: '#eab308', root: '#ea580c' },
            dry: { stem: '#78350f', leafLight: '#a8a29e', leafDark: '#57534e', fruit: '#78350f', fruitAlt: '#92400e', root: '#9a3412' },
            hungry: { stem: '#84cc16', leafLight: '#fef08a', leafDark: '#eab308', fruit: '#ef4444', fruitAlt: '#facc15', root: '#f97316' }
        };

        // --- PIXEL ART SPRITES ---
        const PixelPot = ({ color = "#8B4513" }) => (
            <g><rect x="6" y="15" width="12" height="7" fill={color} /><rect x="5" y="13" width="14" height="2" fill="#5e2f0d" /><rect x="6" y="15" width="12" height="1" fill="#3f1d07" opacity="0.5"/></g>
        );

        const PixelTable = () => (
            <g>
                <rect x="2" y="19" width="2" height="5" fill="#3f2e18" />
                <rect x="20" y="19" width="2" height="5" fill="#3f2e18" />
                <rect x="0" y="19" width="24" height="3" fill="#5c401f" />
                <rect x="0" y="22" width="24" height="1" fill="#362411" opacity="0.5"/>
            </g>
        );

        const PixelSun = () => (
            <svg viewBox="0 0 24 24" width="64" height="64" className="pixel-art animate-spin-slow">
                <rect x="8" y="8" width="8" height="8" fill="#fcd34d" />
                <rect x="10" y="4" width="4" height="2" fill="#f59e0b" />
                <rect x="10" y="18" width="4" height="2" fill="#f59e0b" />
                <rect x="4" y="10" width="2" height="4" fill="#f59e0b" />
                <rect x="18" y="10" width="2" height="4" fill="#f59e0b" />
                <rect x="6" y="6" width="2" height="2" fill="#f59e0b" />
                <rect x="16" y="6" width="2" height="2" fill="#f59e0b" />
                <rect x="6" y="16" width="2" height="2" fill="#f59e0b" />
                <rect x="16" y="16" width="2" height="2" fill="#f59e0b" />
            </svg>
        );

        const PixelMoon = () => (
            <svg viewBox="0 0 24 24" width="50" height="50" className="pixel-art">
                <rect x="8" y="4" width="6" height="2" fill="#e2e8f0" />
                <rect x="6" y="6" width="4" height="2" fill="#e2e8f0" />
                <rect x="4" y="8" width="4" height="8" fill="#e2e8f0" />
                <rect x="6" y="16" width="4" height="2" fill="#e2e8f0" />
                <rect x="8" y="18" width="6" height="2" fill="#e2e8f0" />
                <rect x="12" y="6" width="4" height="12" fill="#94a3b8" />
            </svg>
        );

        const PixelCloud = ({ opacity = 1 }) => (
            <svg viewBox="0 0 32 16" width="64" height="32" className="pixel-art" style={{opacity}}>
                <rect x="8" y="8" width="16" height="6" fill="white" />
                <rect x="4" y="10" width="4" height="4" fill="white" />
                <rect x="24" y="10" width="4" height="4" fill="white" />
                <rect x="8" y="4" width="8" height="4" fill="white" />
                <rect x="16" y="6" width="6" height="2" fill="white" />
            </svg>
        );

        // Plant Visuals
        const PixelTomato = ({ scale = 1, status = 'healthy', variety = 'standard' }) => {
            const c = PALETTES[status];
            let fc = c.fruit;
            if (status === 'healthy') {
                if (variety.includes('black')) fc = '#4a0404'; 
                if (variety.includes('sun') || variety.includes('atomic')) fc = '#f97316'; 
            }
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot />
                        <rect x="8" y="4" width="1" height="10" fill="#a8a29e" />
                        <rect x="15" y="4" width="1" height="10" fill="#a8a29e" />
                        <rect x="8" y="7" width="8" height="1" fill="#a8a29e" />
                        <rect x="8" y="11" width="8" height="1" fill="#a8a29e" />
                        <rect x="11" y="5" width="2" height="9" fill={c.stem} />
                        <rect x="10" y="8" width="4" height="4" fill={c.leafDark} />
                        <rect x="9" y="6" width="3" height="2" fill={c.leafDark} />
                        <rect x="10" y="6" width="2" height="2" fill={fc} />
                        <rect x="13" y="9" width="2" height="2" fill={fc} />
                        <rect x="9" y="10" width="2" height="2" fill={fc} />
                    </g>
                </svg>
            );
        };

        const PixelPepper = ({ scale = 1, status = 'healthy' }) => {
            const c = PALETTES[status];
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot />
                        <rect x="11" y="10" width="2" height="4" fill={c.stem} />
                        <rect x="8" y="6" width="8" height="6" fill={c.leafDark} />
                        <rect x="7" y="8" width="10" height="3" fill={c.leafDark} />
                        <rect x="9" y="8" width="2" height="3" fill={c.fruit} />
                        <rect x="13" y="7" width="2" height="3" fill={c.fruitAlt} />
                    </g>
                </svg>
            );
        };

        const PixelLeafy = ({ scale = 1, status = 'healthy' }) => {
            const c = PALETTES[status];
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot />
                        <rect x="11" y="11" width="2" height="3" fill={c.stem} />
                        <rect x="7" y="9" width="10" height="4" fill={c.leafDark} />
                        <rect x="8" y="7" width="8" height="4" fill={c.leafDark} />
                        <rect x="6" y="10" width="12" height="2" fill={c.leafDark} />
                    </g>
                </svg>
            );
        };

        const PixelRoot = ({ scale = 1, status = 'healthy' }) => {
            const c = PALETTES[status];
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot color="#78350f" />
                        <rect x="11" y="9" width="2" height="4" fill={c.stem} />
                        <rect x="9" y="6" width="6" height="3" fill={c.leafDark} />
                        <rect x="11" y="13" width="2" height="2" fill={c.root} />
                        <rect x="10" y="14" width="4" height="2" fill={c.root} />
                    </g>
                </svg>
            );
        };

        const PixelHerb = ({ scale = 1, status = 'healthy' }) => {
            const c = PALETTES[status];
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot color="#57534e" />
                        <rect x="11" y="11" width="2" height="3" fill={c.stem} />
                        <rect x="8" y="6" width="8" height="7" fill={c.leafDark} />
                        <rect x="7" y="8" width="10" height="4" fill={c.leafDark} />
                        <rect x="9" y="5" width="6" height="2" fill={c.leafLight} />
                    </g>
                </svg>
            );
        };

        const PixelTree = ({ scale=1, status='healthy', variety='' }) => {
            const c = PALETTES[status];
            let fruitColor = c.fruitAlt;
            if(status === 'healthy') {
                if(variety.includes('mulberry')) fruitColor = '#4c1d95';
                if(variety.includes('fig')) fruitColor = '#701a75';
                if(variety.includes('cherry')) fruitColor = '#dc2626';
            }
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0,-4)">
                        <PixelPot color="#3f2e18"/>
                        <rect x="11" y="6" width="2" height="8" fill="#5c401f" />
                        <circle cx="12" cy="6" r="5" fill={c.leafDark} />
                        <circle cx="10" cy="5" r="3" fill={c.leafLight} />
                        <circle cx="14" cy="5" r="3" fill={c.leafLight} />
                        <circle cx="12" cy="4" r="1" fill={fruitColor} /> 
                        <circle cx="10" cy="7" r="1" fill={fruitColor} />
                        <circle cx="14" cy="7" r="1" fill={fruitColor} />
                    </g>
                </svg>
            );
        };

        const PixelBush = ({ scale=1, status='healthy', variety='' }) => {
            const c = PALETTES[status];
            let berryColor = c.fruit;
            if(status==='healthy') {
                if(variety.includes('blue')) berryColor = '#2563eb';
                if(variety.includes('black')) berryColor = '#171717';
                if(variety.includes('rasp')) berryColor = '#be123c';
            }
            return (
                <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                     <PixelTable />
                     <g transform="translate(0,-4)">
                        <PixelPot />
                        <rect x="8" y="6" width="8" height="8" fill={c.leafDark} />
                        <rect x="6" y="8" width="12" height="4" fill={c.leafDark} />
                        <rect x="10" y="7" width="2" height="2" fill={berryColor} />
                        <rect x="8" y="10" width="2" height="2" fill={berryColor} />
                        <rect x="14" y="9" width="2" height="2" fill={berryColor} />
                     </g>
                </svg>
            );
        };

        const PixelGeneric = ({ scale = 1, status = 'healthy' }) => {
             const c = PALETTES[status];
             return (
                 <svg viewBox="0 0 24 24" width={24*scale} height={24*scale} className="pixel-art animate-sway">
                    <PixelTable />
                    <g transform="translate(0, -3)">
                        <PixelPot />
                        <rect x="11" y="8" width="2" height="6" fill={c.stem} />
                        <rect x="9" y="6" width="6" height="4" fill={c.leafDark} />
                        <rect x="8" y="8" width="8" height="4" fill={c.leafDark} />
                    </g>
                </svg>
             );
        };

        const getPlantVisual = (name, scale=1, status='healthy') => {
            const lower = name.toLowerCase();
            if(lower.includes('tomato')) return <PixelTomato scale={scale} status={status} variety={lower} />;
            if(lower.includes('pepper') || lower.includes('chili')) return <PixelPepper scale={scale} status={status} />;
            if(lower.includes('lettuce') || lower.includes('kale') || lower.includes('spinach') || lower.includes('chard')) return <PixelLeafy scale={scale} status={status} />;
            if(lower.includes('basil') || lower.includes('mint') || lower.includes('oregano') || lower.includes('parsley') || lower.includes('thyme')) return <PixelHerb scale={scale} status={status} />;
            if(lower.includes('tree') || lower.includes('lemon') || lower.includes('fig') || lower.includes('cherry') || lower.includes('mulberry')) return <PixelTree scale={scale} status={status} variety={lower} />;
            if(lower.includes('berry') || lower.includes('rasp') || lower.includes('blue') || lower.includes('straw')) return <PixelBush scale={scale} status={status} variety={lower} />;
            if(lower.includes('carrot') || lower.includes('radish') || lower.includes('potato')) return <PixelRoot scale={scale} status={status} />;
            return <PixelGeneric scale={scale} status={status} />;
        };

        // --- ICONS ---
        const IconBase = ({ children, className = "", size = 24, color = "currentColor" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Sun = (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Edit3 = (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>;
        const Droplets = (p) => <IconBase {...p}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.35"/></IconBase>;
        const Utensils = (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Box = (p) => <IconBase {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22.08V12"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const CloudRain = (p) => <IconBase {...p}><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></IconBase>;
        const Thermometer = (p) => <IconBase {...p}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;

        // --- ANIMATION ---
        const CelebrationOverlay = ({ plantName }) => (
            <div className="fixed inset-0 z-[120] flex items-center justify-center pointer-events-none bg-black/40 backdrop-blur-sm transition-opacity duration-500">
                <div className="relative flex flex-col items-center">
                    <div className="animate-grow origin-bottom scale-150 mb-6 drop-shadow-2xl">
                        {getPlantVisual(plantName, 8, 'healthy')}
                    </div>
                    <div className="animate-pop text-center">
                        <span className="text-3xl font-bold text-[#fef3c7] bg-[#451a03] px-8 py-3 rounded-lg shadow-xl border-4 border-[#78350f] pixel-font tracking-widest">PLANTED!</span>
                    </div>
                </div>
            </div>
        );

        // --- APP LOGIC ---
        const App = () => {
            const [plants, setPlants] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [filter, setFilter] = useState('all'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [justAddedPlant, setJustAddedPlant] = useState(null);
            
            const [weather, setWeather] = useState(null);
            const [weatherLoading, setWeatherLoading] = useState(false);
            const [weatherError, setWeatherError] = useState(null);
            const [savedCoords, setSavedCoords] = useState(null);
            
            const fileInputRef = useRef(null);
            
            const [newPlant, setNewPlant] = useState({
                id: null, name: '', nickname: '', location: '', 
                containerMaterial: 'Plastic', containerSize: '3 Gallon', 
                plantedDate: new Date().toISOString().split('T')[0],
                waterFreq: 3, lastWatered: new Date().toISOString().split('T')[0],
                fertilizerFreq: 14, lastFertilized: new Date().toISOString().split('T')[0],
                notes: ''
            });

            useEffect(() => { 
                try { 
                    const saved = localStorage.getItem('balconyTracker_v14'); 
                    if (saved) setPlants(JSON.parse(saved));
                    const coords = localStorage.getItem('garden_coords');
                    if (coords) setSavedCoords(JSON.parse(coords));
                } catch (e) {} 
            }, []);

            useEffect(() => { try { localStorage.setItem('balconyTracker_v14', JSON.stringify(plants)); } catch (e) {} }, [plants]);

            useEffect(() => {
                if (savedCoords) fetchWeather(savedCoords.latitude, savedCoords.longitude);
            }, [savedCoords]);

            const fetchWeather = async (lat, lon) => {
                setWeatherLoading(true); setWeatherError(null);
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,is_day&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum&temperature_unit=fahrenheit&timezone=auto`);
                    if(!response.ok) throw new Error("Weather failed");
                    setWeather(await response.json());
                } catch (err) { setWeatherError("Weather Error"); } finally { setWeatherLoading(false); }
            };

            const requestLocation = () => {
                if (!navigator.geolocation) { setWeatherError("Unsupported"); return; }
                setWeatherLoading(true); setWeatherError(null);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        localStorage.setItem('garden_coords', JSON.stringify({ latitude, longitude }));
                        setSavedCoords({ latitude, longitude });
                    },
                    () => { setWeatherError("Denied"); setWeatherLoading(false); }
                );
            };

            const getWeatherIcon = (code) => {
                if (code <= 1) return <Sun size={14} className="text-yellow-400"/>;
                if (code <= 3) return <Sun size={14} className="text-gray-400"/>;
                if (code <= 67) return <CloudRain size={14} className="text-blue-400"/>;
                return <AlertTriangle size={14} className="text-red-400"/>;
            };

            const getDayName = (isoDate) => new Date(isoDate).toLocaleDateString('en-US', { weekday: 'short' });

            const getWeatherModifier = () => {
                if (!weather) return { val: 1.0, icon: null };
                const maxTemp = weather.daily.temperature_2m_max[0];
                const precip = weather.daily.precipitation_sum[0];
                if (maxTemp > 85) return { val: 0.6, icon: <Sun size={12} className="text-orange-500 animate-pulse"/> }; // Faster dry
                if (precip > 0.2) return { val: 1.5, icon: <CloudRain size={12} className="text-blue-500"/> }; // Slower dry
                return { val: 1.0, icon: null };
            };

            const getWeatherAdvice = () => {
                if (!weather) return [];
                const minTemp = weather.daily.temperature_2m_min[0], maxTemp = weather.daily.temperature_2m_max[0], precip = weather.daily.precipitation_sum[0];
                let alerts = [];
                if (minTemp <= 35) alerts.push({ type: 'danger', icon: <AlertTriangle size={16}/>, msg: "FROST!" });
                if (maxTemp >= 85) alerts.push({ type: 'warning', icon: <Sun size={16}/>, msg: "HEAT WAVE" });
                if (precip > 0.25) alerts.push({ type: 'info', icon: <CloudRain size={16}/>, msg: "RAINY" });
                if (alerts.length === 0) alerts.push({ type: 'neutral', icon: <Sun size={16}/>, msg: `MILD (${maxTemp}Â°)` });
                return alerts;
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(plants));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", "garden_backup.json");
                document.body.appendChild(anchor); anchor.click(); anchor.remove();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            if(confirm(`Restore ${imported.length} plants?`)) setPlants(imported);
                        }
                    } catch (e) { alert("Error"); }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const handleSavePlant = (e) => {
                e.preventDefault(); if (!newPlant.name) return;
                const save = { ...newPlant, id: newPlant.id || Date.now().toString() };
                if (newPlant.id) setPlants(plants.map(p => p.id === newPlant.id ? save : p));
                else { setPlants([...plants, save]); setJustAddedPlant(newPlant.name); setTimeout(() => setJustAddedPlant(null), 2500); }
                closeModal();
            };

            const handleDelete = (id) => { if(confirm("Remove pot?")) setPlants(plants.filter(p => p.id !== id)); };

            const logAction = (id, type) => {
                const today = new Date().toISOString().split('T')[0];
                setPlants(plants.map(p => p.id === id ? (type === 'water' ? { ...p, lastWatered: today } : { ...p, lastFertilized: today }) : p));
            };

            // --- CORE CALCULATION LOGIC ---
            const calculateFrequencies = (basePlant, materialLabel, sizeLabel) => {
                const mat = CONTAINER_MATERIALS.find(m => m.label === materialLabel) || CONTAINER_MATERIALS[0];
                const siz = CONTAINER_SIZES.find(s => s.label === sizeLabel) || CONTAINER_SIZES[3];
                
                // Calculate combined modifier
                const totalWaterMod = mat.waterMod * siz.waterMod;
                const totalFertMod = mat.fertMod * siz.fertMod;

                // Apply to base frequency. Max(1) prevents 0 days.
                const waterFreq = Math.max(1, Math.round(basePlant.waterFreq * totalWaterMod));
                
                // For fertilizer, if base is 0 (like rosemary), keep 0. Else min 7 days.
                const fertFreq = basePlant.fertilizerFreq === 0 ? 0 : Math.max(7, Math.round(basePlant.fertilizerFreq * totalFertMod));
                
                return { waterFreq, fertFreq };
            };

            const selectFromLibrary = (libPlant) => {
                // Calc based on current dropdowns
                const { waterFreq, fertFreq } = calculateFrequencies(libPlant, newPlant.containerMaterial, newPlant.containerSize);
                
                setNewPlant(prev => ({ 
                    ...prev, 
                    name: libPlant.name, 
                    waterFreq, 
                    fertilizerFreq: fertFreq, 
                    notes: libPlant.notes 
                }));
                setSearchTerm('');
            };

            const handleContainerChange = (field, value) => {
                // Update the specific field first
                const updatedPlant = { ...newPlant, [field]: value };
                
                // Find current plant in library to get BASELINE stats
                const libEntry = PLANT_LIBRARY.find(p => p.name === updatedPlant.name);
                
                if (libEntry) {
                    // Recalculate using new container settings + library baseline
                    const { waterFreq, fertFreq } = calculateFrequencies(libEntry, updatedPlant.containerMaterial, updatedPlant.containerSize);
                    updatedPlant.waterFreq = waterFreq;
                    updatedPlant.fertilizerFreq = fertFreq;
                }
                
                setNewPlant(updatedPlant);
            };

            const openEdit = (plant) => { setNewPlant(plant); setSearchTerm(''); setShowModal(true); };
            const openNew = () => {
                setNewPlant({ 
                    id: null, name: '', nickname: '', location: '', 
                    containerMaterial: 'Plastic', containerSize: '3 Gallon', 
                    plantedDate: new Date().toISOString().split('T')[0],
                    waterFreq: 3, lastWatered: new Date().toISOString().split('T')[0],
                    fertilizerFreq: 14, lastFertilized: new Date().toISOString().split('T')[0],
                    notes: ''
                });
                setSearchTerm(''); setShowModal(true);
            };
            const closeModal = () => setShowModal(false);

            const getStatus = (lastDate, freq) => {
                if (parseInt(freq) === 0) return { daysLeft: 999, isDue: false, weatherIcon: null };
                const wMod = getWeatherModifier(); 
                const adjustedFreq = Math.max(1, Math.round(freq * wMod.val));
                const next = new Date(lastDate); next.setDate(next.getDate() + adjustedFreq); next.setHours(0,0,0,0);
                const today = new Date(); today.setHours(0,0,0,0);
                const daysLeft = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
                return { daysLeft, isDue: daysLeft <= 0, weatherIcon: wMod.icon };
            };

            const filteredPlants = plants.filter(p => filter === 'due' ? (getStatus(p.lastWatered, p.waterFreq).isDue || getStatus(p.lastFertilized, p.fertilizerFreq).isDue) : true);
            const librarySuggestions = searchTerm.length > 0 ? PLANT_LIBRARY.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())) : [];
            const weatherAlerts = getWeatherAdvice();
            const uniqueWisdom = Array.from(new Set(plants.map(p => p.name))).map(name => { const l = PLANT_LIBRARY.find(i => i.name === name); return l ? { name: name, tip: l.tip } : null; }).filter(Boolean);
            const isDay = weather ? weather.current.is_day === 1 : true;
            const shelves = [];
            for (let i = 0; i < plants.length; i += 4) { shelves.push(plants.slice(i, i + 4)); }
            if (shelves.length === 0) shelves.push([]);

            return (
                <div className="min-h-screen pb-32">
                    {justAddedPlant && <CelebrationOverlay plantName={justAddedPlant} />}

                    <header className="bg-[#1c1917] text-[#e7e5e4] shadow-lg sticky top-0 z-10 border-b-4 border-[#44403c]">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-3xl filter grayscale-[30%]">ðŸŒ¿</span>
                                <div>
                                    <h1 className="text-2xl font-bold leading-none tracking-wide text-[#a8a29e]">BALCONY</h1>
                                    <h1 className="text-xl font-bold leading-none tracking-wide text-[#d97706]">GARDEN</h1>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="bg-[#292524] text-[#a8a29e] p-2 rounded-lg border border-[#44403c] hover:text-[#d6d3d1]" title="Export"><Download size={18} /></button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                <button onClick={() => fileInputRef.current.click()} className="bg-[#292524] text-[#a8a29e] p-2 rounded-lg border border-[#44403c] hover:text-[#d6d3d1]" title="Import"><Upload size={18} /></button>
                                <button onClick={openNew} className="wood-btn px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 text-lg transition-transform pixel-font tracking-widest ml-2"><Plus size={18} /> ADD</button>
                            </div>
                        </div>

                        <div className="bg-[#292524] p-2 border-b border-[#44403c]">
                            <div className="max-w-4xl mx-auto">
                                {!weather ? (
                                    <button onClick={requestLocation} className="w-full text-xs text-[#a8a29e] hover:text-white flex items-center justify-center gap-2 bg-[#44403c] px-3 py-2 rounded-sm border border-[#57534e] pixel-font">
                                        <MapPin size={14} /> ENABLE WEATHER
                                    </button>
                                ) : (
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center justify-between overflow-x-auto pb-1 gap-2">
                                            <div className="flex flex-col items-center p-2 bg-[#3f3f46] rounded-sm border border-[#52525b] min-w-[70px]">
                                                <span className="text-[10px] text-[#a1a1aa] font-bold">NOW</span>
                                                <span className="text-xl font-bold text-[#f59e0b] pixel-font">{Math.round(weather.current.temperature_2m)}Â°</span>
                                                {getWeatherIcon(weather.daily.weathercode[0])}
                                            </div>
                                            {weather.daily.time.slice(1).map((day, idx) => (
                                                <div key={idx} className="flex flex-col items-center p-1 min-w-[50px] border-r border-[#44403c] last:border-0">
                                                    <span className="text-[10px] text-[#71717a] font-bold uppercase">{getDayName(day)}</span>
                                                    <div className="my-1">{getWeatherIcon(weather.daily.weathercode[idx+1])}</div>
                                                    <span className="text-xs text-[#d4d4d8] font-mono">{Math.round(weather.daily.temperature_2m_max[idx+1])}Â°</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto p-4 space-y-6">
                        
                        {/* VISUAL GARDEN BED */}
                        <div className={`rounded-xl card-shadow overflow-hidden border-4 border-[#451a03] relative min-h-[40vh] flex flex-col transition-colors duration-2000 ${isDay ? 'bg-gradient-to-b from-sky-400 via-sky-200 to-amber-100' : 'bg-gradient-to-b from-slate-900 via-indigo-950 to-purple-900'}`}>
                            
                            {/* SKY */}
                            <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden">
                                <div className="absolute top-6 right-6 transition-all duration-1000 z-10">
                                    {isDay ? <PixelSun /> : <PixelMoon />}
                                </div>
                                {!isDay && (
                                    <>
                                        <div className="absolute top-10 left-10 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '0.2s'}}></div>
                                        <div className="absolute top-20 left-1/3 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '0.5s'}}></div>
                                        <div className="absolute top-5 right-1/4 w-1 h-1 bg-white rounded-full animate-twinkle" style={{animationDelay: '1s'}}></div>
                                    </>
                                )}
                                {isDay && (
                                    <>
                                        <div className="absolute top-10 left-[-10%] animate-drift opacity-80"><PixelCloud /></div>
                                        <div className="absolute top-24 left-[-40%] animate-drift-fast opacity-60"><PixelCloud opacity={0.6} /></div>
                                        <div className="absolute top-5 left-[-80%] animate-drift-slow opacity-40" style={{transform: 'scale(0.5)'}}><PixelCloud opacity={0.4} /></div>
                                    </>
                                )}
                            </div>

                            <div className="absolute top-6 left-0 right-0 text-center z-10">
                                <h3 className="text-[#78350f] font-bold pixel-font text-3xl mb-1 opacity-90 bg-[#f0ebe5]/90 mx-auto w-fit px-6 py-1 rounded-sm shadow-sm border-2 border-[#78350f]/20">MY PLOT</h3>
                            </div>
                            
                            {/* SHELVES */}
                            <div className="pt-24 pb-0 px-4 relative z-10 flex flex-col gap-8 items-center w-full justify-end flex-grow">
                                {shelves.map((shelfPlants, shelfIdx) => (
                                    <div key={shelfIdx} className="relative w-full max-w-md flex flex-col items-center">
                                        <div className="flex items-end justify-center gap-2 sm:gap-6 w-full px-2 z-10 pb-[2px]">
                                            {shelfPlants.length === 0 && shelfIdx === 0 && <span className="text-white/80 text-lg mb-4 pixel-font animate-pulse">Empty plot... plant something!</span>}
                                            {shelfPlants.map((plant, idx) => {
                                                const water = getStatus(plant.lastWatered, plant.waterFreq);
                                                const food = getStatus(plant.lastFertilized, plant.fertilizerFreq);
                                                let status = 'healthy';
                                                if (water.isDue) status = 'dry'; else if (food.isDue) status = 'hungry';
                                                return (
                                                    <div key={plant.id} className="flex-shrink-0 flex flex-col items-center group relative cursor-help filter drop-shadow-xl transition-all duration-300 hover:scale-110">
                                                        <div>{getPlantVisual(plant.name, 3, status)}</div>
                                                        <div className="absolute bottom-full mb-2 hidden group-hover:block bg-slate-900 text-slate-100 text-xs px-2 py-1 rounded-sm border border-slate-700 whitespace-nowrap z-20 pixel-font shadow-lg">
                                                            {plant.nickname || plant.name}
                                                            {status === 'dry' && <span className="block text-red-400 text-[10px]">THIRSTY</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        {/* Shelf */}
                                        <div className="w-full h-4 bg-[#5c401f] border-t-4 border-[#3f2e18] rounded-sm shadow-lg relative"></div>
                                    </div>
                                ))}
                                
                                {/* FLOOR */}
                                <div className="w-full h-16 bg-[#78350f] border-t-8 border-[#451a03] mt-4 relative pixel-art" style={{backgroundImage: 'linear-gradient(45deg, #451a03 25%, transparent 25%, transparent 75%, #451a03 75%, #451a03), linear-gradient(45deg, #451a03 25%, transparent 25%, transparent 75%, #451a03 75%, #451a03)', backgroundSize: '20px 20px', backgroundPosition: '0 0, 10px 10px', opacity: 0.9}}></div>
                            </div>
                        </div>

                        <div className="flex gap-2 bg-[#292524] p-1 rounded-lg border border-[#44403c]">
                            <button onClick={() => setFilter('all')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition-colors pixel-font tracking-wide ${filter === 'all' ? 'bg-[#57534e] text-[#f5f5f4] border border-[#78716c]' : 'text-[#a8a29e] hover:bg-[#44403c]'}`}>FULL GARDEN</button>
                            <button onClick={() => setFilter('due')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition-colors pixel-font tracking-wide ${filter === 'due' ? 'bg-[#78350f] text-[#fef3c7] border border-[#92400e]' : 'text-[#a8a29e] hover:bg-[#44403c]'}`}>NEEDS CARE</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {filteredPlants.length === 0 && <div className="col-span-full text-center py-12 text-[#57534e]"><Box size={48} className="mx-auto opacity-50 mb-2"/><p className="pixel-font text-xl">No pots found.</p></div>}
                            {filteredPlants.map(plant => {
                                const water = getStatus(plant.lastWatered, plant.waterFreq);
                                const food = getStatus(plant.lastFertilized, plant.fertilizerFreq);
                                let status = 'healthy';
                                if (water.isDue) status = 'dry'; else if (food.isDue) status = 'hungry';

                                return (
                                    <div key={plant.id} className="bg-[#f0ebe5] rounded-xl card-shadow overflow-hidden relative border-2 border-[#a8a29e]">
                                        <div className="absolute top-2 right-2 flex gap-1">
                                             <button onClick={() => openEdit(plant)} className="p-1.5 text-[#78716c] hover:text-[#292524] rounded-sm hover:bg-[#e7e5e4]"><Edit3 size={16} /></button>
                                             <button onClick={() => handleDelete(plant.id)} className="p-1.5 text-[#78716c] hover:text-[#7f1d1d] rounded-sm hover:bg-[#fecaca]"><Trash2 size={16} /></button>
                                        </div>
                                        <div className="p-4">
                                            <div className="flex gap-3 mb-4">
                                                <div className="shrink-0 pt-1 filter drop-shadow-sm">{getPlantVisual(plant.name, 2, status)}</div>
                                                <div className="pr-14">
                                                    {plant.nickname ? (
                                                        <>
                                                            <h2 className="text-xl font-bold text-[#292524] leading-tight pixel-font tracking-wide">{plant.nickname}</h2>
                                                            <p className="text-xs text-[#57534e] font-bold uppercase tracking-wider">{plant.name}</p>
                                                        </>
                                                    ) : (
                                                        <h2 className="text-xl font-bold text-[#292524] leading-tight pixel-font tracking-wide">{plant.name}</h2>
                                                    )}
                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                        <span className="bg-[#e7e5e4] text-[#57534e] text-[10px] px-2 py-0.5 rounded-sm border border-[#d6d3d1] font-bold uppercase pixel-font truncate max-w-[100px]">{plant.containerMaterial}</span>
                                                        <span className="bg-[#e7e5e4] text-[#57534e] text-[10px] px-2 py-0.5 rounded-sm border border-[#d6d3d1] font-bold uppercase pixel-font truncate max-w-[100px]">{plant.containerSize}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className={`p-2.5 rounded-lg border-2 flex flex-col justify-between ${water.isDue ? 'bg-[#eff6ff] border-[#60a5fa]' : 'bg-[#fafaf9] border-[#d6d3d1]'}`}>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-[10px] font-black uppercase text-[#2563eb] pixel-font tracking-wider">Water</span>
                                                        {water.isDue && <div className="w-2 h-2 rounded-sm bg-[#3b82f6] animate-pulse"></div>}
                                                    </div>
                                                    <div className="mb-2 pixel-font text-lg leading-none flex items-center gap-2">
                                                        {water.isDue ? <span className="text-[#1d4ed8] font-bold">DRY!</span> : <span className="text-[#78716c]">{water.daysLeft} days</span>}
                                                        {water.weatherIcon}
                                                    </div>
                                                    <button onClick={() => logAction(plant.id, 'water')} className="w-full bg-[#dbeafe] hover:bg-[#bfdbfe] text-[#1e40af] text-xs font-bold py-1.5 rounded-sm border border-[#93c5fd] transition-colors flex items-center justify-center gap-1 pixel-font"><Droplets size={12}/> WATERED</button>
                                                </div>
                                                <div className={`p-2.5 rounded-lg border-2 flex flex-col justify-between ${food.isDue ? 'bg-[#f0fdf4] border-[#4ade80]' : 'bg-[#fafaf9] border-[#d6d3d1]'}`}>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-[10px] font-black uppercase text-[#16a34a] pixel-font tracking-wider">Feed</span>
                                                        {food.isDue && <div className="w-2 h-2 rounded-sm bg-[#22c55e] animate-pulse"></div>}
                                                    </div>
                                                    <div className="mb-2 pixel-font text-lg leading-none">
                                                        {food.isDue ? <span className="text-[#15803d] font-bold">HUNGRY!</span> : <span className="text-[#78716c]">{food.daysLeft} days</span>}
                                                    </div>
                                                    <button onClick={() => logAction(plant.id, 'food')} className="w-full bg-[#dcfce7] hover:bg-[#bbf7d0] text-[#166534] text-xs font-bold py-1.5 rounded-sm border border-[#86efac] transition-colors flex items-center justify-center gap-1 pixel-font"><Utensils size={12}/> FED</button>
                                                </div>
                                            </div>
                                            {plant.notes && <div className="mt-3 pt-2 border-t border-[#d6d3d1] text-xs text-[#57534e] font-mono">"{plant.notes}"</div>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {uniqueWisdom.length > 0 && (
                            <div className="bg-[#fef3c7] border-4 border-[#d97706] rounded-xl p-4 card-shadow">
                                <h3 className="text-lg font-bold text-[#92400e] mb-3 flex items-center gap-2 pixel-font tracking-wider"><BookOpen size={20}/> ALMANAC WISDOM</h3>
                                <div className="space-y-2 font-mono text-sm text-[#78350f]">
                                    {uniqueWisdom.map((item, idx) => <div key={idx} className="flex gap-2"><span className="font-bold uppercase shrink-0">[{item.name}]:</span><span>{item.tip}</span></div>)}
                                </div>
                            </div>
                        )}
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-auto bg-[#1c1917]/80 backdrop-blur-sm">
                            <div className="bg-[#f0ebe5] w-full max-w-md h-[85vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-xl overflow-hidden card-shadow border-t-4 sm:border-4 border-[#44403c] flex flex-col relative animate-slide-up">
                                <div className="bg-[#292524] p-4 flex justify-between items-center border-b-4 border-[#44403c] shrink-0">
                                    <h3 className="font-bold text-xl text-[#d6d3d1] pixel-font tracking-widest">{newPlant.id ? 'EDIT POT' : 'NEW POT'}</h3>
                                    <button onClick={closeModal}><X size={24} className="text-[#a8a29e] hover:text-[#f5f5f4]" /></button>
                                </div>
                                <div className="overflow-y-auto p-6 space-y-5 flex-grow">
                                    {!newPlant.id && (
                                        <div className="relative group z-30">
                                            <div className="flex items-center border-2 border-[#a8a29e] rounded-sm p-2 bg-[#e7e5e4] focus-within:border-[#78350f] transition-colors">
                                                <Search size={20} className="text-[#78716c] mr-2" />
                                                <input type="text" placeholder="SEARCH ALMANAC..." className="w-full bg-transparent outline-none text-[#292524] placeholder-[#a8a29e] font-bold pixel-font tracking-wider" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                            </div>
                                            {librarySuggestions.length > 0 && (
                                                <ul className="absolute left-0 right-0 mt-2 bg-[#f0ebe5] border-2 border-[#44403c] rounded-sm shadow-xl max-h-48 overflow-y-auto library-scroll z-50">
                                                    {librarySuggestions.map((plant, idx) => (
                                                        <li key={idx} onClick={() => selectFromLibrary(plant)} className="p-2 hover:bg-[#d6d3d1] cursor-pointer border-b border-[#d6d3d1] last:border-0">
                                                            <div className="flex items-center gap-3">
                                                                {getPlantVisual(plant.name, 1.2)}
                                                                <div>
                                                                    <div className="font-bold text-[#292524] pixel-font tracking-wide">{plant.name}</div>
                                                                    <div className="text-[10px] text-[#57534e] uppercase font-bold tracking-wider font-mono">Water Base: {plant.waterFreq}d â€¢ Feed Base: {plant.fertilizerFreq}d</div>
                                                                </div>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    )}
                                    <form onSubmit={handleSavePlant} className="space-y-4 font-mono">
                                        <div>
                                            <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Plant Type</label>
                                            <input type="text" required className="w-full border-b-2 border-[#a8a29e] p-2 focus:border-[#78350f] outline-none text-lg font-bold text-[#292524] bg-transparent pixel-font" value={newPlant.name} onChange={(e) => setNewPlant({...newPlant, name: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Nickname</label>
                                            <input type="text" placeholder="e.g. 'Big Bertha'" className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-[#e7e5e4] text-slate-900 focus:bg-white focus:border-[#78350f] outline-none transition-colors font-bold" value={newPlant.nickname} onChange={(e) => setNewPlant({...newPlant, nickname: e.target.value})} />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Location</label>
                                                <input type="text" placeholder="e.g. Railing" className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-[#e7e5e4] text-slate-900 font-bold" value={newPlant.location} onChange={(e) => setNewPlant({...newPlant, location: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Pot Material</label>
                                                <select className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-white text-slate-900 font-bold" value={newPlant.containerMaterial} onChange={(e) => handleContainerChange('containerMaterial', e.target.value)}>
                                                    {CONTAINER_MATERIALS.map((opt, idx) => <option key={idx} value={opt.label}>{opt.label}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Pot Size</label>
                                            <select className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm bg-white text-slate-900 font-bold" value={newPlant.containerSize} onChange={(e) => handleContainerChange('containerSize', e.target.value)}>
                                                {CONTAINER_SIZES.map((opt, idx) => <option key={idx} value={opt.label}>{opt.label}</option>)}
                                            </select>
                                        </div>
                                        <div className="bg-[#dbeafe] p-3 rounded-lg border-2 border-[#93c5fd]">
                                            <div className="flex items-center gap-2 mb-2 text-[#1e40af] font-bold text-xs uppercase tracking-wide pixel-font">
                                                <Droplets size={14} /> Water Schedule
                                            </div>
                                            <div className="flex gap-3 items-center">
                                                <div className="flex items-center bg-white rounded-sm border border-[#93c5fd] px-2">
                                                    <input type="number" min="1" className="w-12 p-2 text-center font-bold text-[#1e40af] outline-none pixel-font text-lg" value={newPlant.waterFreq} onChange={(e) => setNewPlant({...newPlant, waterFreq: e.target.value})} />
                                                    <span className="text-xs text-[#3b82f6] font-bold mr-2 pixel-font">DAYS</span>
                                                </div>
                                                <div className="flex-grow text-right">
                                                    <label className="text-[10px] text-[#3b82f6] font-bold block mb-1 pixel-font">LAST WATERED</label>
                                                    <input type="date" className="border border-[#93c5fd] rounded-sm p-1 text-xs text-[#1e40af] font-bold bg-white font-mono" value={newPlant.lastWatered} onChange={(e) => setNewPlant({...newPlant, lastWatered: e.target.value})} />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-[#dcfce7] p-3 rounded-lg border-2 border-[#86efac]">
                                            <div className="flex items-center gap-2 mb-2 text-[#166534] font-bold text-xs uppercase tracking-wide pixel-font">
                                                <Utensils size={14} /> Feed Schedule
                                            </div>
                                            <div className="flex gap-3 items-center">
                                                <div className="flex items-center bg-white rounded-sm border border-[#86efac] px-2">
                                                    <input type="number" min="0" className="w-12 p-2 text-center font-bold text-[#166534] outline-none pixel-font text-lg" value={newPlant.fertilizerFreq} onChange={(e) => setNewPlant({...newPlant, fertilizerFreq: e.target.value})} />
                                                    <span className="text-xs text-[#22c55e] font-bold mr-2 pixel-font">DAYS</span>
                                                </div>
                                                <div className="flex-grow text-right">
                                                    <label className="text-[10px] text-[#22c55e] font-bold block mb-1 pixel-font">LAST FED</label>
                                                    <input type="date" className="border border-[#86efac] rounded-sm p-1 text-xs text-[#166534] font-bold bg-white font-mono" value={newPlant.lastFertilized} onChange={(e) => setNewPlant({...newPlant, lastFertilized: e.target.value})} />
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-[#78716c] uppercase tracking-widest pixel-font">Notes</label>
                                            <textarea className="w-full border-2 border-[#a8a29e] rounded-sm p-2 mt-1 text-sm h-20 resize-none bg-[#e7e5e4] text-slate-900 font-mono" value={newPlant.notes} onChange={(e) => setNewPlant({...newPlant, notes: e.target.value})}></textarea>
                                        </div>
                                        <div className="pb-6">
                                            <button type="submit" className="w-full wood-btn py-3 rounded-sm text-xl pixel-font tracking-widest flex justify-center items-center gap-2">
                                                <Save size={20} /> PLANT IT!
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
